<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤å‚³è²ç­’ - é»é¤ä»‹é¢</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        button:focus { outline: none; }
        .cart-item-enter { opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
        /* éš±è—é è¨­çš„æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• */
        input[type="file"] { display: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="container mx-auto max-w-lg p-4 pb-48">

        <!-- è®€å–ä¸­ç•«é¢ -->
        <div id="loading" class="text-center py-20">
            <p class="text-gray-500">æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ...</p>
        </div>

        <!-- ä¸»å…§å®¹ (é è¨­éš±è—) -->
        <main id="main-content" class="hidden">
            <!-- åº—å®¶è³‡è¨Š -->
            <header class="mb-6">
                <p id="liff-status" class="text-xs text-center text-green-600 mb-2 p-2 bg-green-50 rounded-md"></p>
                <h1 id="store-name" class="text-3xl font-bold text-gray-800 text-center">é»é¤å‚³è²ç­’</h1>
                <p id="lang-info" class="text-sm text-gray-500 text-center mt-1"></p>
            </header>

            <!-- èªè¨€é¡¯ç¤º (å¾ LINE Bot å‚³å…¥) -->
            <section class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <p id="current-language-display" class="text-sm text-gray-600 mb-2">é¡¯ç¤ºèªè¨€ï¼š<span id="language-name">ä¸­æ–‡</span></p>
                    <p class="text-xs text-gray-400">èªè¨€å·²åœ¨ LINE Bot ä¸­è¨­å®š</p>
                </div>
            </section>

            <!-- åº—å®¶è³‡è¨Šé¡¯ç¤º -->
            <section id="store-info" class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <h2 id="current-store-name" class="text-lg font-bold text-gray-700 mb-2">è¼‰å…¥ä¸­...</h2>
                    <p id="store-type-badge" class="text-sm text-gray-500">æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ</p>
                </div>
            </section>

            <!-- éåˆä½œåº—å®¶ä¸Šå‚³å€å¡Š -->
            <section id="ocr-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full mb-3">
                        <span class="text-2xl">ğŸ“¸</span>
                    </div>
                    <h2 id="ocr-title" class="text-lg font-bold text-gray-700 mb-2">éåˆä½œåº—å®¶</h2>
                    <p id="ocr-description" class="text-sm text-gray-500">è«‹æ‹æ”æˆ–ä¸Šå‚³æ¸…æ¥šçš„èœå–®ç…§ç‰‡ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨å³æ™‚ç¿»è­¯ä¸¦å»ºç«‹é»é¤å–®ã€‚</p>
                </div>
                
                <!-- åœ–ç‰‡é è¦½ -->
                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="èœå–®é è¦½" class="max-h-60 w-auto mx-auto rounded-md shadow-sm"/>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <p id="ocr-status" class="text-center text-blue-600 font-semibold my-4 hidden"></p>

                <!-- æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• -->
                <label for="menu-upload" class="w-full text-center cursor-pointer bg-indigo-600 text-white font-bold py-3 px-6 rounded-full hover:bg-indigo-700 transition-colors block">
                    é¸æ“‡èœå–®ç…§ç‰‡
                </label>
                <input type="file" id="menu-upload" accept="image/*">

                <!-- ä¸Šå‚³æŒ‰éˆ• (é¸æ“‡ç…§ç‰‡å¾Œé¡¯ç¤º) -->
                <button id="upload-btn" class="w-full mt-3 bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition-colors hidden disabled:bg-gray-400">
                    é–‹å§‹è¾¨è­˜èœå–®
                </button>
            </section>

            <!-- èœå–®åˆ—è¡¨ -->
            <section id="menu-list" class="space-y-4">
                <!-- èœå–®é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
            </section>
        </main>
    </div>

    <!-- åº•éƒ¨è³¼ç‰©è»Š / ä¸‹å–®æ¬„ -->
    <footer id="cart-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg hidden">
        <div class="container mx-auto max-w-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <span id="total-label" class="text-sm text-gray-600">ç¸½è¨ˆ</span>
                    <p class="text-2xl font-bold text-gray-900">NT$ <span id="total-price">0</span></p>
                </div>
                <button id="submit-order" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-colors disabled:bg-gray-300">
                    é€å‡ºè¨‚å–®
                </button>
            </div>
        </div>
    </footer>

    <!-- å¼•å…¥ LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/sdk/v2/sdk.js"></script>

    <script>
        // --- ç’°å¢ƒè®Šæ•¸è¨­å®š ---
        // æ­£å¼ç’°å¢ƒå¾Œç«¯ç¶²å€
        const API_BASE_URL = 'https://ordering-helper-backend-1095766716155.asia-east1.run.app'; // Cloud Run å¾Œç«¯ç¶²å€
        const LIFF_ID = '2007869241-5EdeyzYp'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID (ä¾‹å¦‚: 1234567890-abcdefgh)
        // å–å¾— LIFF ID å¾Œï¼Œè«‹å°‡ä¸Šé¢çš„ 'your-liff-id' æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› LIFF ID
        // æ›´æ–°æ™‚é–“: 2025-01-27 - é‡æ–°å•Ÿç”¨ Azure éƒ¨ç½²

        // --- å…¨å±€è®Šæ•¸ ---
        let cart = {}; // è³¼ç‰©è»Šç‰©ä»¶
        let currentMenuItems = []; // ç•¶å‰é é¢é¡¯ç¤ºçš„èœå–®é …ç›®
        let currentLanguage = 'zh-TW'; // ç•¶å‰èªè¨€
        let currentStore = null; // ç•¶å‰é¸æ“‡çš„åº—å®¶
        let liffInitialized = false; // LIFF åˆå§‹åŒ–ç‹€æ…‹

        // --- æ¨¡æ“¬è³‡æ–™ ---
        const MOCK_STORES = [
            { store_id: 1, store_name: "ç‹é˜¿å¬¤è‡­è±†è…", partner_level: "A", address: "å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ" },
            { store_id: 2, store_name: "å°æç‰›è‚‰éºµ", partner_level: "B", address: "å°åŒ—å¸‚å¤§å®‰å€å¿ å­æ±è·¯å››æ®µ1è™Ÿ" },
            { store_id: 3, store_name: "é˜¿å©†æ»·è‚‰é£¯", partner_level: "C", address: "å°åŒ—å¸‚ä¸­å±±å€ä¸­å±±åŒ—è·¯ä¸€æ®µ1è™Ÿ" }
        ];

        const MOCK_API_RESPONSE = {
            "zh-TW": { "store_name": "ç‹é˜¿å¬¤è‡­è±†è…", "items": [ { "menu_item_id": 101, "item_name": "æ‹›ç‰Œè‡­è±†è…", "description": "å¤–é…¥å…§å«©çš„ç™¼é…µè±†è…ï¼Œæ­é…ç‰¹è£½æ³¡èœã€‚", "price_small": 60 }, { "menu_item_id": 102, "item_name": "çç å¥¶èŒ¶", "description": "ç¶“å…¸å°ç£æ‰‹æ–é£²ï¼ŒQå½ˆçç æ­é…é¦™æ¿ƒå¥¶èŒ¶ã€‚", "price_small": 50 } ] },
            "en-US": { "store_name": "Grandma Wang's Stinky Tofu", "items": [ { "menu_item_id": 101, "item_name": "Crispy Stinky Tofu", "description": "Fermented tofu deep-fried to golden perfection.", "price_small": 60 }, { "menu_item_id": 102, "item_name": "Bubble Milk Tea", "description": "Classic Taiwanese milk tea with tapioca pearls.", "price_small": 50 } ] },
            "ja-JP": { "store_name": "ç‹ãŠã°ã‚ã¡ã‚ƒã‚“ã®è‡­è±†è…", "items": [ { "menu_item_id": 101, "item_name": "çœ‹æ¿è‡­è±†è…", "description": "å¤–ã¯ã‚«ãƒªã‚«ãƒªã€ä¸­ã¯ãµã‚ãµã‚ã®ç™ºé…µè±†è…ã€‚", "price_small": 60 }, { "menu_item_id": 102, "item_name": "ã‚¿ãƒ”ã‚ªã‚«ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼", "description": "ã‚‚ã¡ã‚‚ã¡ã®ã‚¿ãƒ”ã‚ªã‚«ã¨æ¿ƒåšãªãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼ã€‚", "price_small": 50 } ] },
            "ko-KR": { "store_name": "ì™• í• ë¨¸ë‹ˆì˜ ëƒ„ìƒˆë‚˜ëŠ” ë‘ë¶€", "items": [ { "menu_item_id": 101, "item_name": "ì‹œê·¸ë‹ˆì²˜ ëƒ„ìƒˆë‚˜ëŠ” ë‘ë¶€", "description": "ë°”ì‚­í•˜ê³  ë¶€ë“œëŸ¬ìš´ ë°œíš¨ ë‘ë¶€, íŠ¹ì œ ê¹€ì¹˜ì™€ í•¨ê»˜.", "price_small": 60 }, { "menu_item_id": 102, "item_name": "ë²„ë¸” ë°€í¬í‹°", "description": "í´ë˜ì‹ ëŒ€ë§Œ ë°€í¬í‹°, ì«„ê¹ƒí•œ íƒ€í”¼ì˜¤ì¹´ í„ê³¼ í•¨ê»˜.", "price_small": 50 } ] }
        };

        const MOCK_GEMINI_RESPONSE = [
            { "item_name": "ç‰›è‚‰éºµ", "price_small": 150 },
            { "item_name": "æ’éª¨é£¯", "price_small": 120 },
            { "item_name": "ç‡™é’èœ", "price_small": 40 }
        ];

        // --- ä¸»è¦åŸ·è¡Œå‡½æ•¸ ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeLiff();
            await initializeParameters();
            
            // éš±è—è®€å–ç•«é¢ï¼Œé¡¯ç¤ºä¸»å…§å®¹
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

        // --- åŠŸèƒ½å‡½æ•¸ ---

        async function initializeLiff() {
            if (LIFF_ID === 'your-liff-id') {
                const statusElement = document.getElementById('liff-status');
                statusElement.innerHTML = `<span class="text-red-600 font-bold">è¨­å®šéŒ¯èª¤ï¼š</span><span class="text-gray-700">è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ä½ çš„ LIFF IDã€‚</span>`;
                statusElement.classList.add('bg-red-50', 'text-red-600');
                return;
            }
            try {
                await liff.init({ liffId: LIFF_ID });
                console.log('LIFF init success');
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById('liff-status').textContent = `ä½ å¥½ ${profile.displayName}ï¼`;
                    console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                } else {
                    document.getElementById('liff-status').textContent = 'LIFF åˆå§‹åŒ–æˆåŠŸ (æœªç™»å…¥)';
                }
                liffInitialized = true;
            } catch (error) {
                console.error("LIFF Initialization failed", error);
                // é–‹ç™¼ç’°å¢ƒï¼šé¡¯ç¤ºæ¨¡æ“¬è¨Šæ¯
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('azurewebsites.net')) {
                    document.getElementById('liff-status').textContent = 'é–‹ç™¼æ¨¡å¼ï¼šLIFF æ¨¡æ“¬ç’°å¢ƒ';
                } else {
                    document.getElementById('liff-status').textContent = 'LIFF åˆå§‹åŒ–å¤±æ•—ã€‚';
                }
            }
        }



        async function initializeParameters() {
            // å¾ URL åƒæ•¸å–å¾—æ‰€æœ‰å¿…è¦è³‡è¨Š
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store_id');
            const language = urlParams.get('lang') || 'zh-TW';
            const isPartner = urlParams.get('partner') === 'true';
            const storeName = urlParams.get('store_name') || 'æœªçŸ¥åº—å®¶';
            
            // è¨­å®šå…¨å±€è®Šæ•¸
            currentStore = storeId;
            currentLanguage = language;
            
            // ç›´æ¥é¡¯ç¤ºåº—å®¶è³‡è¨Šï¼ˆå¾Œç«¯æœƒè™•ç†ç¿»è­¯ï¼‰
            document.getElementById('current-store-name').textContent = storeName;
            document.getElementById('store-type-badge').innerHTML = isPartner 
                ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">åˆä½œåº—å®¶</span>'
                : '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">éåˆä½œåº—å®¶</span>';
            
            // æ›´æ–°èªè¨€é¡¯ç¤º
            updateLanguageDisplay();
            updateLanguageInfo();
            
            // æ ¹æ“šåˆä½œç‹€æ…‹æ±ºå®šé¡¯ç¤ºä»‹é¢
            if (isPartner) {
                // åˆä½œåº—å®¶æ¨¡å¼ - ç›´æ¥è¼‰å…¥èœå–®
                await loadPartnerStoreMenu(storeId, language);
            } else {
                // éåˆä½œåº—å®¶æ¨¡å¼ - é¡¯ç¤º OCR ä¸Šå‚³ä»‹é¢
                showNonPartnerInterface();
            }
        }

        function updateLanguageDisplay() {
            const langNames = {
                'zh-TW': 'ä¸­æ–‡',
                'en-US': 'English',
                'ja-JP': 'æ—¥æœ¬èª',
                'ko-KR': 'í•œêµ­ì–´'
            };
            
            const languageName = langNames[currentLanguage] || 'ä¸­æ–‡';
            document.getElementById('language-name').textContent = languageName;
            
            // æ›´æ–°èªè¨€è³‡è¨Š
            updateLanguageInfo();
        }

        function updateLanguageInfo() {
            const langNames = {
                'zh-TW': 'ä¸­æ–‡',
                'en-US': 'English',
                'ja-JP': 'æ—¥æœ¬èª',
                'ko-KR': 'í•œêµ­ì–´'
            };
            const languageName = langNames[currentLanguage] || 'ä¸­æ–‡';
            document.getElementById('lang-info').textContent = 
                `åº—å®¶ID: ${currentStore || 'æœªé¸æ“‡'} / èªè¨€: ${languageName}`;
        }



        async function loadPartnerStoreMenu(storeId, language) {
            try {
                // éš±è— OCR ä»‹é¢
                document.getElementById('ocr-section').classList.add('hidden');
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const menuList = document.getElementById('menu-list');
                menuList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">æ­£åœ¨è¼‰å…¥èœå–®...</p>
                    </div>
                `;
                
                // å‘å¾Œç«¯è«‹æ±‚èœå–®è³‡æ–™
                const response = await fetch(`${API_BASE_URL}/api/menus/${storeId}?lang=${language}`);
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥èœå–®');
                }
                const data = await response.json();
                
                // æ¸²æŸ“èœå–®
                if (data && data.items && data.items.length > 0) {
                    renderMenu(data.items);
                } else {
                    // å¦‚æœæ²’æœ‰èœå–®è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    menuList.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-600 mb-4">ç„¡æ³•è¼‰å…¥èœå–®è³‡æ–™</p>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                é‡æ–°è¼‰å…¥
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥åˆä½œåº—å®¶èœå–®å¤±æ•—:', error);
                // ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                const mockData = MOCK_API_RESPONSE[language] || MOCK_API_RESPONSE['zh-TW'];
                renderMenu(mockData.items);
            }
        }

        function showNonPartnerInterface() {
            // é¡¯ç¤ºéåˆä½œåº—å®¶ä»‹é¢
            document.getElementById('ocr-section').classList.remove('hidden');
            
            // åˆå§‹åŒ–éåˆä½œåº—å®¶æ¨¡å¼
            setupNonPartnerMode();
        }

        function setupNonPartnerMode() {
            const fileInput = document.getElementById('menu-upload');
            const uploadBtn = document.getElementById('upload-btn');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    previewImage.src = URL.createObjectURL(file);
                    previewContainer.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                }
            });

            uploadBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼');
                    return;
                }
                await handleOcrUpload(file, currentLanguage);
            });
        }

        async function handleOcrUpload(file, language) {
            const ocrStatus = document.getElementById('ocr-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            // é¡¯ç¤ºè™•ç†ç‹€æ…‹
            ocrStatus.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>æ­£åœ¨ä¸Šå‚³ä¸¦è«‹ AI è¾¨è­˜èœå–®...</span>
                </div>
            `;
            ocrStatus.classList.remove('hidden');
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('lang', language);
                formData.append('store_id', currentStore || 1);
                
                const response = await fetch(`${API_BASE_URL}/api/upload-menu-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('AI è¾¨è­˜å¤±æ•—');
                }
                
                const data = await response.json();
                
                // é¡¯ç¤ºæˆåŠŸç‹€æ…‹
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-green-600">
                        <span class="text-xl">âœ…</span>
                        <span>è¾¨è­˜å®Œæˆï¼æ­£åœ¨ç”Ÿæˆé»é¤ä»‹é¢...</span>
                    </div>
                `;
                setTimeout(() => ocrStatus.classList.add('hidden'), 2000);
                
                // æ¸²æŸ“è¾¨è­˜çµæœ
                if (data.menu_data && data.menu_data.items) {
                    renderMenu(data.menu_data.items);
                } else {
                    // ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                    const mockItems = MOCK_GEMINI_RESPONSE.map((item, index) => ({
                        ...item,
                        menu_item_id: `ocr-${index}`
                    }));
                    renderMenu(mockItems);
                }

            } catch (error) {
                console.error("OCR è™•ç†å¤±æ•—:", error);
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-red-600">
                        <span class="text-xl">âŒ</span>
                        <span>è¾¨è­˜å¤±æ•—ï¼Œè«‹æ›å¼µç…§ç‰‡æˆ–ç¨å¾Œå†è©¦ã€‚</span>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function renderMenu(items) {
            currentMenuItems = items;
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';
            
            items.forEach(item => {
                menuList.appendChild(createMenuItemElement(item));
            });
            
            document.getElementById('cart-footer').classList.remove('hidden');
        }

        function createMenuItemElement(item) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-md flex items-center space-x-4';
            div.innerHTML = `
                <div class="w-16 h-16 bg-gray-200 rounded-md flex-shrink-0">
                    <img src="https://placehold.co/64x64/e2e8f0/334155?text=${item.item_name.charAt(0)}" class="w-full h-full object-cover rounded-md" alt="${item.item_name}">
                </div>
                <div class="flex-grow">
                    <h3 class="font-bold text-lg text-gray-800">${item.item_name}</h3>
                    <p class="text-sm text-gray-500">${item.description || ''}</p>
                    <p class="text-md font-semibold text-blue-600 mt-1">NT$ ${item.price_small}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button data-item-id="${item.menu_item_id}" class="decrease-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg hover:bg-gray-300 transition">-</button>
                    <span id="quantity-${item.menu_item_id}" class="font-bold text-lg w-6 text-center">0</span>
                    <button data-item-id="${item.menu_item_id}" class="increase-btn bg-blue-500 text-white w-8 h-8 rounded-full font-bold text-lg hover:bg-blue-600 transition">+</button>
                </div>
            `;
            div.querySelector('.increase-btn').addEventListener('click', () => updateCart(item, 1));
            div.querySelector('.decrease-btn').addEventListener('click', () => updateCart(item, -1));
            return div;
        }

        function updateCart(item, change) {
            const itemId = item.menu_item_id;
            const currentQuantity = cart[itemId] || 0;
            const newQuantity = Math.max(0, currentQuantity + change);
            cart[itemId] = newQuantity;
            document.getElementById(`quantity-${itemId}`).textContent = newQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            let total = 0;
            for (const itemId in cart) {
                const quantity = cart[itemId];
                if (quantity > 0) {
                    const item = currentMenuItems.find(i => i.menu_item_id == itemId);
                    if (item) {
                        total += item.price_small * quantity;
                    }
                }
            }
            document.getElementById('total-price').textContent = total;
            document.getElementById('submit-order').disabled = total === 0;
        }

        function showOrderConfirmation(result, orderDetails) {
            const mainContent = document.getElementById('main-content');
            const cartFooter = document.getElementById('cart-footer');
            
            // éš±è—è³¼ç‰©è»Š
            cartFooter.classList.add('hidden');
            
            // é¡¯ç¤ºç¢ºèªé é¢
            mainContent.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4">âœ…</div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">è¨‚å–®å·²ç¢ºèªï¼</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <p class="text-lg font-semibold text-gray-700 mb-4">ğŸ“‹ è¨‚å–®ç·¨è™Ÿ: ${result.order_id}</p>
                        <p class="text-lg font-semibold text-blue-600 mb-4">ğŸ’° ç¸½é‡‘é¡: NT$ ${document.getElementById('total-price').textContent}</p>
                        <div class="text-left bg-gray-50 p-4 rounded-md mb-4">
                            <p class="font-semibold text-gray-700 mb-2">ğŸ“ è¨‚å–®å…§å®¹:</p>
                            <p class="text-sm text-gray-600 whitespace-pre-line">${orderDetails}</p>
                        </div>
                        <p class="text-gray-600">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼Œæˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨æº–å‚™é¤é»ï¼</p>
                    </div>
                    <button onclick="closeLiffWindow()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        é—œé–‰è¦–çª—
                    </button>
                </div>
            `;
        }

        function closeLiffWindow() {
            if (liffInitialized && liff.isLoggedIn()) {
                liff.closeWindow();
            } else {
                // å¦‚æœä¸åœ¨ LIFF ç’°å¢ƒä¸­ï¼Œé¡¯ç¤ºä¸€èˆ¬è¨Šæ¯
                alert('è¨‚å–®å·²æˆåŠŸé€å‡ºï¼');
            }
        }

        document.getElementById('submit-order').addEventListener('click', async () => {
            if (Object.keys(cart).length === 0 || Object.values(cart).every(q => q === 0)) {
                alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');
                return;
            }
            
            try {
                const orderItems = Object.entries(cart)
                    .filter(([_, quantity]) => quantity > 0)
                    .map(([itemId, quantity]) => {
                        const item = currentMenuItems.find(i => i.menu_item_id == itemId);
                        return {
                            menu_item_id: itemId,
                            quantity: quantity,
                            price: item.price_small
                        };
                    });

                const response = await fetch(`${API_BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        store_id: currentStore,
                        items: orderItems,
                        language: currentLanguage
                    })
                });

                if (!response.ok) {
                    throw new Error('è¨‚å–®å»ºç«‹å¤±æ•—');
                }

                const result = await response.json();
                
                const orderDetails = orderItems
                    .map(item => {
                        const menuItem = currentMenuItems.find(i => i.menu_item_id == item.menu_item_id);
                        return `${menuItem.item_name} x ${item.quantity}`;
                    }).join('\n');

                // é¡¯ç¤ºè¨‚å–®ç¢ºèªé é¢
                showOrderConfirmation(result, orderDetails);
                
                // æ¸…ç©ºè³¼ç‰©è»Š
                cart = {};
                currentMenuItems.forEach(item => {
                    document.getElementById(`quantity-${item.menu_item_id}`).textContent = '0';
                });
                updateTotalPrice();
                
            } catch (error) {
                console.error('é€å‡ºè¨‚å–®å¤±æ•—:', error);
                alert('è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        });
    </script>

</body>
</html> 