<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>點餐傳聲筒 - 點餐介面</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        button:focus { outline: none; }
        .cart-item-enter { opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
        /* 隱藏預設的檔案上傳按鈕 */
        input[type="file"] { display: none; }
        
        /* 隱藏店家ID/語言那行 */
        #lang-info {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="container mx-auto max-w-lg p-4 pb-48">

        <!-- 讀取中畫面 -->
        <div id="loading" class="text-center py-20">
            <p class="text-gray-500">正在準備點餐環境...</p>
        </div>

        <!-- 主內容 (預設隱藏) -->
        <main id="main-content" class="hidden">
            <!-- 店家資訊 -->
            <header class="mb-6">
                <p id="liff-status" class="text-xs text-center text-green-600 mb-2 p-2 bg-green-50 rounded-md"></p>
                <h1 id="store-name" class="text-3xl font-bold text-gray-800 text-center">點餐傳聲筒</h1>
                <p id="lang-info" class="text-sm text-gray-500 text-center mt-1"></p>
            </header>

            <!-- 語言顯示 (從 LINE Bot 傳入) -->
            <section class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <p id="current-language-display" class="text-sm text-gray-600 mb-2">顯示語言：<span id="language-name">中文</span></p>
                    <p class="text-xs text-gray-400">語言已在 LINE Bot 中設定</p>
                </div>
            </section>

            <!-- 店家資訊顯示 -->
            <section id="store-info" class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <h2 id="current-store-name" class="text-lg font-bold text-gray-700 mb-2">載入中...</h2>
                    <p id="store-type-badge" class="text-sm text-gray-500">正在準備點餐環境</p>
                </div>
            </section>

            <!-- 非合作店家上傳區塊 -->
            <section id="ocr-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full mb-3">
                        <span class="text-2xl">📸</span>
                    </div>
                    <h2 id="ocr-title" class="text-lg font-bold text-gray-700 mb-2">非合作店家</h2>
                    <p id="ocr-description" class="text-sm text-gray-500">請拍攝或上傳清楚的菜單照片，我們將為您即時翻譯並建立點餐單。</p>
                </div>
                
                <!-- 圖片預覽 -->
                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="菜單預覽" class="max-h-60 w-auto mx-auto rounded-md shadow-sm"/>
                </div>

                <!-- 狀態訊息 -->
                <p id="ocr-status" class="text-center text-blue-600 font-semibold my-4 hidden"></p>

                <!-- 檔案上傳按鈕 -->
                <label for="menu-upload" class="w-full text-center cursor-pointer bg-indigo-600 text-white font-bold py-3 px-6 rounded-full hover:bg-indigo-700 transition-colors block">
                    選擇菜單照片
                </label>
                <input type="file" id="menu-upload" accept="image/*">

                <!-- 上傳按鈕 (選擇照片後顯示) -->
                <button id="upload-btn" class="w-full mt-3 bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition-colors hidden disabled:bg-gray-400">
                    開始辨識菜單
                </button>
            </section>

            <!-- 菜單列表 -->
            <section id="menu-list" class="space-y-4">
                <!-- 菜單項目將由 JavaScript 動態生成於此 -->
            </section>
        </main>
    </div>

    <!-- 底部購物車 / 下單欄 -->
    <footer id="cart-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg hidden">
        <div class="container mx-auto max-w-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <span id="total-label" class="text-sm text-gray-600">總計</span>
                    <p class="text-2xl font-bold text-gray-900">NT$ <span id="total-price">0</span></p>
                </div>
                <button id="submit-order" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-colors disabled:bg-gray-300">
                    送出訂單
                </button>
            </div>
        </div>
    </footer>

    <!-- 引入 LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // --- 環境變數設定 ---
        // 正式環境後端網址
        const API_BASE_URL = 'https://ordering-helper-backend-1095766716155.asia-east1.run.app'; // Cloud Run 後端網址
        const LIFF_ID = '2007881521-VavMAlwe'; // 請替換為您的 LIFF ID (例如: 1234567890-abcdefgh)
        // 取得 LIFF ID 後，請將上面的 'your-liff-id' 替換為您的實際 LIFF ID
        // 更新時間: 2025-01-27 - 重新啟用 Azure 部署

        // --- 全局變數 ---
        let cart = {}; // 購物車物件
        let currentMenuItems = []; // 當前頁面顯示的菜單項目
        let currentLanguage = 'zh-TW'; // 當前語言
        let currentStore = null; // 當前選擇的店家
        let liffInitialized = false; // LIFF 初始化狀態
        let currentUserId = null; // 當前使用者 ID



        // --- 主要執行函數 ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 等待 LIFF SDK 載入完成
            await waitForLiff();
            await initializeLiff();
            await initializeParameters();
            
            // 隱藏讀取畫面，顯示主內容
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

        // 等待 LIFF SDK 載入
        async function waitForLiff() {
            return new Promise((resolve) => {
                const checkLiff = () => {
                    if (typeof liff !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkLiff, 100);
                    }
                };
                checkLiff();
            });
        }

        // --- 功能函數 ---

        async function initializeLiff() {
            if (LIFF_ID === 'your-liff-id') {
                const statusElement = document.getElementById('liff-status');
                statusElement.innerHTML = `<span class="text-red-600 font-bold">設定錯誤：</span><span class="text-gray-700">請在程式碼中填入你的 LIFF ID。</span>`;
                statusElement.classList.add('bg-red-50', 'text-red-600');
                return;
            }
            try {
                // 檢查是否在 LINE 環境中
                const isInClient = liff.isInClient();
                
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: isInClient // 只在 LINE 環境中要求登入
                });
                console.log('LIFF init success');
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId; // 儲存 LINE 使用者 ID
                    document.getElementById('liff-status').textContent = `你好 ${profile.displayName}！`;
                    console.log('用戶資料:', profile);
                } else {
                    // 非 LIFF 環境或未登入時，使用訪客 ID
                    currentUserId = `guest_${crypto.randomUUID().slice(0, 8)}`;
                    document.getElementById('liff-status').textContent = isInClient 
                        ? 'LIFF 初始化成功 (未登入)' 
                        : '開發模式：LIFF 模擬環境';
                }
                liffInitialized = true;
            } catch (error) {
                console.error("LIFF Initialization failed", error);
                // 開發環境：顯示模擬訊息
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('azurewebsites.net')) {
                    document.getElementById('liff-status').textContent = '開發模式：LIFF 模擬環境';
                } else {
                    document.getElementById('liff-status').textContent = 'LIFF 初始化失敗。';
                }
                // 初始化失敗時也設定訪客 ID
                currentUserId = `guest_${crypto.randomUUID().slice(0, 8)}`;
            }
        }



        async function initializeParameters() {
            // 從 URL 參數取得所有必要資訊
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store_id');
            const language = urlParams.get('lang') || 'zh-TW';
            const isPartner = urlParams.get('partner') === 'true';
            const storeName = urlParams.get('store_name') || '未知店家';
            
            // 設定全局變數 - 確保 currentStore 有有效值
            currentStore = storeId || 'non-partner';
            currentLanguage = language;
            
            // 除錯：顯示實際的URL參數
            console.log('URL參數:', {
                store_id: storeId,
                language: language,
                isPartner: isPartner,
                storeName: storeName,
                currentStore: currentStore
            });
            
            // 直接顯示店家資訊（後端會處理翻譯）
            document.getElementById('current-store-name').textContent = storeName;
            document.getElementById('store-type-badge').innerHTML = isPartner 
                ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">合作店家</span>'
                : '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">非合作店家</span>';
            
            // 更新語言顯示
            updateLanguageDisplay();
            updateLanguageInfo();
            
            // 根據合作狀態決定顯示介面
            if (isPartner) {
                // 合作店家模式 - 直接載入菜單
                await loadPartnerStoreMenu(storeId, language);
            } else {
                // 非合作店家模式 - 顯示 OCR 上傳介面
                showNonPartnerInterface();
            }
        }

        function updateLanguageDisplay() {
            const langNames = {
                'zh-TW': '中文',
                'en-US': 'English',
                'ja-JP': '日本語',
                'ko-KR': '한국어'
            };
            
            const languageName = langNames[currentLanguage] || '中文';
            document.getElementById('language-name').textContent = languageName;
            
            // 更新語言資訊
            updateLanguageInfo();
        }

        function updateLanguageInfo() {
            const langNames = {
                'zh-TW': '中文',
                'en-US': 'English',
                'ja-JP': '日本語',
                'ko-KR': '한국어'
            };
            const languageName = langNames[currentLanguage] || '中文';
            document.getElementById('lang-info').textContent = 
                `店家ID: ${currentStore || '未選擇'} / 語言: ${languageName}`;
        }



        async function loadPartnerStoreMenu(storeId, language) {
            try {
                // 隱藏 OCR 介面
                document.getElementById('ocr-section').classList.add('hidden');
                
                // 顯示載入狀態
                const menuList = document.getElementById('menu-list');
                menuList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">正在載入菜單...</p>
                    </div>
                `;
                
                // 向後端請求菜單資料
                const response = await fetch(`${API_BASE_URL}/api/menus/${storeId}?lang=${language}`);
                if (!response.ok) {
                    throw new Error('無法載入菜單');
                }
                const data = await response.json();
                
                // 渲染菜單
                if (data && data.items && data.items.length > 0) {
                    try {
                        renderMenu(data.items);
                    } catch (renderError) {
                        console.error('前端渲染錯誤:', renderError);
                        menuList.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-red-600 mb-4">菜單渲染時發生錯誤，請截圖給工程師</p>
                                <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                    重新載入
                                </button>
                            </div>
                        `;
                    }
                } else {
                    // 如果沒有菜單資料，顯示錯誤訊息
                    menuList.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-600 mb-4">無法載入菜單資料</p>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                重新載入
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('載入合作店家菜單失敗:', error);
                // 顯示錯誤訊息
                menuList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-600 mb-4">無法載入菜單資料</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                            重新載入
                        </button>
                    </div>
                `;
            }
        }

        function showNonPartnerInterface() {
            // 顯示非合作店家介面
            document.getElementById('ocr-section').classList.remove('hidden');
            
            // 初始化非合作店家模式
            setupNonPartnerMode();
        }

        function setupNonPartnerMode() {
            const fileInput = document.getElementById('menu-upload');
            const uploadBtn = document.getElementById('upload-btn');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    previewImage.src = URL.createObjectURL(file);
                    previewContainer.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                }
            });

            uploadBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) {
                    alert('請先選擇一張照片！');
                    return;
                }
                
                // 壓縮圖片
                const compressedFile = await compress(file);
                await handleOcrUpload(compressedFile, currentLanguage);
            });
        }

        // 圖片壓縮函數 (優化版)
        function compress(imgFile) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 1024 / Math.max(img.width, img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(b => {
                        const compressedFile = new File([b], imgFile.name, {type:'image/jpeg'});
                        console.log('圖片壓縮完成:', {
                            原始大小: imgFile.size,
                            壓縮後大小: compressedFile.size,
                            壓縮比例: Math.round((1 - compressedFile.size / imgFile.size) * 100) + '%',
                            新尺寸: `${canvas.width}×${canvas.height}`
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', 0.85);
                };
                img.src = URL.createObjectURL(imgFile);
            });
        }

        async function handleOcrUpload(file, language) {
            const ocrStatus = document.getElementById('ocr-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            // 顯示處理狀態
            ocrStatus.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>正在上傳並請 AI 辨識菜單...</span>
                </div>
            `;
            ocrStatus.classList.remove('hidden');
            uploadBtn.disabled = true;

            try {
                // 檢查並確保 store_id 有有效值
                const storeId = currentStore || 'non-partner';
                console.log('即將上傳 store_id:', storeId);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('lang', language);
                formData.append('store_id', storeId);
                
                console.log('準備上傳檔案:', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    language: language,
                    storeId: storeId
                });
                
                const response = await fetch(`${API_BASE_URL}/api/upload-menu-image`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('API 回應狀態:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API 錯誤回應:', errorData);
                    throw new Error(errorData.error || `系統忙碌，稍後重試 (${response.status})`);
                }
                
                // 201 Created 也是成功狀態
                console.log('API 呼叫成功:', response.status);
                
                const data = await response.json();
                console.log('後端回傳的完整資料:', data);
                
                // 檢查資料結構
                if (data.menu_items) {
                    console.log('menu_items 存在:', data.menu_items);
                    console.log('items 數量:', data.menu_items.length);
                } else {
                    console.log('menu_items 不存在，檢查其他可能的欄位');
                    console.log('可用的欄位:', Object.keys(data));
                }
                
                // 顯示成功狀態
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-green-600">
                        <span class="text-xl">✅</span>
                        <span>辨識完成！正在生成點餐介面...</span>
                    </div>
                `;
                setTimeout(() => ocrStatus.classList.add('hidden'), 2000);
                
                // 渲染辨識結果
                if (data.menu_items && data.menu_items.length > 0) {
                    try {
                        renderMenu(data.menu_items);
                        // 渲染成功，隱藏狀態訊息
                        setTimeout(() => ocrStatus.classList.add('hidden'), 2000);
                    } catch (renderError) {
                        console.error('前端渲染錯誤:', renderError);
                        ocrStatus.innerHTML = `
                            <div class="flex items-center justify-center space-x-2 text-red-600">
                                <span class="text-xl">⚠️</span>
                                <span>菜單渲染時發生錯誤，請截圖給工程師</span>
                            </div>
                        `;
                    }
                } else {
                    // 顯示錯誤訊息
                    ocrStatus.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 text-red-600">
                            <span class="text-xl">❌</span>
                            <span>辨識結果為空，請換張照片或稍後再試。</span>
                        </div>
                    `;
                }

            } catch (error) {
                console.error("OCR 處理失敗:", error);
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-red-600">
                        <span class="text-xl">❌</span>
                        <span>辨識失敗，請換張照片或稍後再試。</span>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function renderMenu(items) {
            currentMenuItems = items;
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';
            
            items.forEach(item => {
                const element = createMenuItemElement(item);
                if (element) {
                    menuList.appendChild(element);
                }
            });
            
            document.getElementById('cart-footer').classList.remove('hidden');
        }

        function createMenuItemElement(item) {
            // 安全處理可能為空的欄位
            const safeStr = (value) => (value ?? '').toString();
            const safeNum = (value) => (value ?? 0);
            
            // 支援多種可能的欄位名稱
            const itemName = safeStr(item.translated_name || item.original_name || item.item_name || '未命名');
            const description = safeStr(item.description || '');
            const price = safeNum(item.price || item.price_small || 0);
            const itemId = item.id || item.menu_item_id || item.temp_id || `temp_${Date.now()}_${Math.random()}`;
            
            // 驗證必要欄位 - 只要有名稱和價格就顯示
            if (!itemName || itemName === '未命名') {
                console.warn('菜單項目缺少名稱，略過此項:', item);
                return null;
            }
            
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-md flex items-center space-x-4';
            div.innerHTML = `
                <div class="w-16 h-16 bg-gray-200 rounded-md flex-shrink-0">
                    <img src="https://placehold.co/64x64/e2e8f0/334155?text=${itemName.charAt(0) || '🍽️'}" class="w-full h-full object-cover rounded-md" alt="${itemName}">
                </div>
                <div class="flex-grow">
                    <h3 class="font-bold text-lg text-gray-800">${itemName}</h3>
                    <p class="text-sm text-gray-500">${description}</p>
                    <p class="text-md font-semibold text-blue-600 mt-1">NT$ ${price}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button data-item-id="${itemId}" class="decrease-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg hover:bg-gray-300 transition">-</button>
                    <span id="quantity-${itemId}" class="font-bold text-lg w-6 text-center">0</span>
                    <button data-item-id="${itemId}" class="increase-btn bg-blue-500 text-white w-8 h-8 rounded-full font-bold text-lg hover:bg-blue-600 transition">+</button>
                </div>
            `;
            div.querySelector('.increase-btn').addEventListener('click', () => updateCart(item, 1));
            div.querySelector('.decrease-btn').addEventListener('click', () => updateCart(item, -1));
            return div;
        }

        function updateCart(item, change) {
            // 使用與 createMenuItemElement 相同的邏輯來取得 itemId
            const itemId = item.id || item.menu_item_id || item.temp_id || `temp_${Date.now()}_${Math.random()}`;
            const currentQuantity = cart[itemId] || 0;
            const newQuantity = Math.max(0, currentQuantity + change);
            cart[itemId] = newQuantity;
            document.getElementById(`quantity-${itemId}`).textContent = newQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            let total = 0;
            for (const itemId in cart) {
                const quantity = cart[itemId];
                if (quantity > 0) {
                    // 使用多種可能的 ID 欄位來匹配項目
                    const item = currentMenuItems.find(i => 
                        (i.id == itemId) || 
                        (i.menu_item_id == itemId) || 
                        (i.temp_id == itemId)
                    );
                    if (item) {
                        const price = item.price || item.price_small || 0;
                        total += price * quantity;
                    }
                }
            }
            document.getElementById('total-price').textContent = total;
            document.getElementById('submit-order').disabled = total === 0;
        }

        function showOrderConfirmation(result, orderDetails) {
            const mainContent = document.getElementById('main-content');
            const cartFooter = document.getElementById('cart-footer');
            
            // 隱藏購物車
            cartFooter.classList.add('hidden');
            
            // 顯示確認頁面
            mainContent.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4">✅</div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">訂單已確認！</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <p class="text-lg font-semibold text-gray-700 mb-4">📋 訂單編號: ${result.order_id}</p>
                        <p class="text-lg font-semibold text-blue-600 mb-4">💰 總金額: NT$ ${document.getElementById('total-price').textContent}</p>
                        <div class="text-left bg-gray-50 p-4 rounded-md mb-4">
                            <p class="font-semibold text-gray-700 mb-2">📝 訂單內容:</p>
                            <p class="text-sm text-gray-600 whitespace-pre-line">${orderDetails}</p>
                        </div>
                        <p class="text-gray-600">感謝您的訂購，我們會盡快為您準備餐點！</p>
                    </div>
                    <button onclick="closeLiffWindow()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        關閉視窗
                    </button>
                </div>
            `;
        }

        function closeLiffWindow() {
            if (liffInitialized && liff.isLoggedIn()) {
                liff.closeWindow();
            } else {
                // 如果不在 LIFF 環境中，顯示一般訊息
                alert('訂單已成功送出！');
            }
        }

        document.getElementById('submit-order').addEventListener('click', async () => {
            if (Object.keys(cart).length === 0 || Object.values(cart).every(q => q === 0)) {
                alert('購物車是空的！');
                return;
            }
            
            try {
                // 1. 驗證購物車資料
                const cartItems = Object.entries(cart)
                    .filter(([_, quantity]) => quantity > 0);
                
                if (cartItems.length === 0) {
                    alert('購物車是空的！');
                    return;
                }
                
                // 2. 建立訂單項目（支援多種格式，與後端相容）
                let totalAmount = 0;
                const orderItems = cartItems.map(([itemId, quantity]) => {
                    // 使用多種可能的 ID 欄位來匹配項目
                    const item = currentMenuItems.find(i => 
                        (i.id == itemId) || 
                        (i.menu_item_id == itemId) || 
                        (i.temp_id == itemId)
                    );
                    
                    if (!item) {
                        console.warn('找不到菜單項目:', itemId);
                        return null;
                    }
                    
                    // 驗證價格（支援多種價格欄位）
                    const priceUnit = item.price_small || item.price || item.price_unit || 0;
                    if (!priceUnit || isNaN(priceUnit) || priceUnit <= 0) {
                        console.error('價格無效:', item);
                        const itemName = item.translated_name || item.original_name || item.item_name || '項目';
                        alert(`${itemName} 沒有有效價格，請先編輯`);
                        throw new Error('價格無效');
                    }
                    
                    // 驗證數量
                    if (!quantity || quantity <= 0) {
                        console.warn('數量無效:', quantity);
                        return null;
                    }
                    
                    const itemTotal = priceUnit * quantity;
                    totalAmount += itemTotal;
                    
                    // 返回訂單項目（支援多種欄位名稱格式）
                    return {
                        // 支援多種 ID 格式
                        menu_item_id: item.menu_item_id || item.id || item.temp_id,
                        // 支援多種數量欄位名稱
                        quantity: quantity,  // 後端也支援 qty
                        qty: quantity,      // 後端也支援 quantity
                        // 支援多種價格欄位名稱
                        price_unit: priceUnit,  // 後端也支援 price 或 price_small
                        price: priceUnit,       // 後端也支援 price_unit
                        // 額外資訊（可選）
                        item_name: item.translated_name || item.original_name || item.item_name,
                        subtotal: itemTotal
                    };
                }).filter(Boolean); // 過濾掉無效項目

                if (orderItems.length === 0) {
                    alert('沒有有效的訂單項目！');
                    return;
                }

                // 3. 準備請求資料（與後端完全相容）
                const payload = {
                    line_user_id: currentUserId, // 加入使用者 ID
                    store_id: currentStore || 'non-partner',
                    items: orderItems,
                    total: totalAmount,  // 可選，後端會重新計算
                    language: currentLanguage
                };

                console.log('發送訂單 payload:', payload);

                // 4. 發送請求
                const response = await fetch(`${API_BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                // 5. 處理回應（改善錯誤處理）
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('後端錯誤回應:', errorData);
                    
                    // 顯示詳細的錯誤訊息
                    let errorMessage = '訂單建立失敗';
                    if (errorData.validation_errors) {
                        errorMessage = `資料驗證失敗：\n${errorData.validation_errors.join('\n')}`;
                    } else if (errorData.missing_fields) {
                        errorMessage = `缺少必要欄位：${errorData.missing_fields.join(', ')}`;
                    } else if (errorData.detail) {
                        errorMessage = errorData.detail;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else {
                        errorMessage = `${response.statusText} (${response.status})`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                const orderDetails = orderItems
                    .map(item => {
                        // 使用多種可能的 ID 欄位來匹配項目
                        const menuItem = currentMenuItems.find(i => 
                            (i.id == item.menu_item_id) || 
                            (i.menu_item_id == item.menu_item_id) || 
                            (i.temp_id == item.menu_item_id)
                        );
                        if (menuItem) {
                            const itemName = menuItem.translated_name || menuItem.original_name || menuItem.item_name || '未命名';
                            return `${itemName} x ${item.qty}`;
                        }
                        return `項目 ${item.menu_item_id} x ${item.qty}`;
                    }).join('\n');

                // 顯示訂單確認頁面
                showOrderConfirmation(result, orderDetails);
                
                // 清空購物車
                cart = {};
                currentMenuItems.forEach(item => {
                    const itemId = item.id || item.menu_item_id || item.temp_id;
                    const quantityElement = document.getElementById(`quantity-${itemId}`);
                    if (quantityElement) {
                        quantityElement.textContent = '0';
                    }
                });
                updateTotalPrice();
                
            } catch (error) {
                console.error('送出訂單失敗:', error);
                alert(`訂單送出失敗：${error.message}`);
            }
        });
    </script>

</body>
</html> 
