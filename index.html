<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤å‚³è²ç­’ - é»é¤ä»‹é¢</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        button:focus { outline: none; }
        .cart-item-enter { opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; }
        /* éš±è—é è¨­çš„æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• */
        input[type="file"] { display: none; }
        
        /* éš±è—åº—å®¶ID/èªè¨€é‚£è¡Œ */
        #lang-info {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app" class="container mx-auto max-w-lg p-4 pb-48">

        <!-- è®€å–ä¸­ç•«é¢ -->
        <div id="loading" class="text-center py-20">
            <p class="text-gray-500">æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ...</p>
        </div>

        <!-- ä¸»å…§å®¹ (é è¨­éš±è—) -->
        <main id="main-content" class="hidden">
            <!-- åº—å®¶è³‡è¨Š -->
            <header class="mb-6">
                <p id="liff-status" class="text-xs text-center text-green-600 mb-2 p-2 bg-green-50 rounded-md"></p>
                <h1 id="store-name" class="text-3xl font-bold text-gray-800 text-center">é»é¤å‚³è²ç­’</h1>
                <p id="lang-info" class="text-sm text-gray-500 text-center mt-1"></p>
            </header>

            <!-- èªè¨€é¡¯ç¤º (å¾ LINE Bot å‚³å…¥) -->
            <section class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <p id="current-language-display" class="text-sm text-gray-600 mb-2">é¡¯ç¤ºèªè¨€ï¼š<span id="language-name">ä¸­æ–‡</span></p>
                    <p class="text-xs text-gray-400">èªè¨€å·²åœ¨ LINE Bot ä¸­è¨­å®š</p>
                </div>
            </section>

            <!-- åº—å®¶è³‡è¨Šé¡¯ç¤º -->
            <section id="store-info" class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="text-center">
                    <h2 id="current-store-name" class="text-lg font-bold text-gray-700 mb-2">è¼‰å…¥ä¸­...</h2>
                    <p id="store-type-badge" class="text-sm text-gray-500">æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ</p>
                </div>
            </section>

            <!-- éåˆä½œåº—å®¶ä¸Šå‚³å€å¡Š -->
            <section id="ocr-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full mb-3">
                        <span class="text-2xl">ğŸ“¸</span>
                    </div>
                    <h2 id="ocr-title" class="text-lg font-bold text-gray-700 mb-2">éåˆä½œåº—å®¶</h2>
                    <p id="ocr-description" class="text-sm text-gray-500">è«‹æ‹æ”æˆ–ä¸Šå‚³æ¸…æ¥šçš„èœå–®ç…§ç‰‡ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨å³æ™‚ç¿»è­¯ä¸¦å»ºç«‹é»é¤å–®ã€‚</p>
                </div>
                
                <!-- åœ–ç‰‡é è¦½ -->
                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="èœå–®é è¦½" class="max-h-60 w-auto mx-auto rounded-md shadow-sm"/>
                </div>

                <!-- ç‹€æ…‹è¨Šæ¯ -->
                <p id="ocr-status" class="text-center text-blue-600 font-semibold my-4 hidden"></p>

                <!-- çµ±ä¸€çš„æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• -->
                <div class="text-center">
                    <label for="menu-upload" class="w-full text-center cursor-pointer bg-indigo-600 text-white font-bold py-4 px-8 rounded-full hover:bg-indigo-700 transition-colors block text-lg">
                        ğŸ“¸ é¸æ“‡èœå–®ç…§ç‰‡
                    </label>
                    <input type="file" id="menu-upload" accept="image/*" style="display: none;">
                    <p class="text-xs text-gray-500 mt-2">æ”¯æ´æ‹ç…§æˆ–å¾ç›¸ç°¿é¸æ“‡</p>
                </div>

                <!-- ä¸Šå‚³æŒ‰éˆ• (é¸æ“‡ç…§ç‰‡å¾Œé¡¯ç¤º) -->
                <button id="upload-btn" class="w-full mt-3 bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition-colors hidden disabled:bg-gray-400">
                    é–‹å§‹è¾¨è­˜èœå–®
                </button>
            </section>

            <!-- èœå–®åˆ—è¡¨ -->
            <section id="menu-list" class="space-y-4">
                <!-- èœå–®é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
            </section>
        </main>
    </div>

    <!-- åº•éƒ¨è³¼ç‰©è»Š / ä¸‹å–®æ¬„ -->
    <footer id="cart-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg hidden">
        <div class="container mx-auto max-w-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <span id="total-label" class="text-sm text-gray-600">ç¸½è¨ˆ</span>
                    <p class="text-2xl font-bold text-gray-900">NT$ <span id="total-price">0</span></p>
                </div>
                <button id="submit-order" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-colors disabled:bg-gray-300">
                    é€å‡ºè¨‚å–®
                </button>
            </div>
        </div>
    </footer>

    <!-- å¼•å…¥ LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // --- ç’°å¢ƒè®Šæ•¸è¨­å®š ---
        // æ­£å¼ç’°å¢ƒå¾Œç«¯ç¶²å€
        const API_BASE_URL = 'https://ordering-helper-backend-1095766716155.asia-east1.run.app'; // Cloud Run å¾Œç«¯ç¶²å€
        const LIFF_ID = '2007881521-VavMAlwe'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID (ä¾‹å¦‚: 1234567890-abcdefgh)
        // å–å¾— LIFF ID å¾Œï¼Œè«‹å°‡ä¸Šé¢çš„ 'your-liff-id' æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› LIFF ID
        // æ›´æ–°æ™‚é–“: 2025-01-27 - é‡æ–°å•Ÿç”¨ Azure éƒ¨ç½²

        // --- å…¨å±€è®Šæ•¸ ---
        let cart = {}; // è³¼ç‰©è»Šç‰©ä»¶
        let currentMenuItems = []; // ç•¶å‰é é¢é¡¯ç¤ºçš„èœå–®é …ç›®
        let currentLanguage = 'zh-TW'; // ç•¶å‰èªè¨€
        let currentStore = null; // ç•¶å‰é¸æ“‡çš„åº—å®¶
        let liffInitialized = false; // LIFF åˆå§‹åŒ–ç‹€æ…‹
        let currentUserId = null; // ç•¶å‰ä½¿ç”¨è€… ID

        // --- å¤šèªè¨€æ–‡å­—å°æ‡‰è¡¨ ---
        const translations = {
            'zh-TW': {
                // é é¢æ¨™é¡Œ
                pageTitle: 'é»é¤å‚³è²ç­’ - é»é¤ä»‹é¢',
                appTitle: 'é»é¤å‚³è²ç­’',
                
                // è¼‰å…¥ç‹€æ…‹
                loadingText: 'æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ...',
                loadingMenu: 'æ­£åœ¨è¼‰å…¥èœå–®...',
                
                // èªè¨€é¡¯ç¤º
                languageDisplay: 'é¡¯ç¤ºèªè¨€ï¼š',
                languageNote: 'èªè¨€å·²åœ¨ LINE Bot ä¸­è¨­å®š',
                
                // åº—å®¶è³‡è¨Š
                storeLoading: 'è¼‰å…¥ä¸­...',
                partnerStore: 'åˆä½œåº—å®¶',
                nonPartnerStore: 'éåˆä½œåº—å®¶',
                preparingOrder: 'æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ',
                
                // OCR ä»‹é¢
                ocrTitle: 'éåˆä½œåº—å®¶',
                ocrDescription: 'è«‹æ‹æ”æˆ–ä¸Šå‚³æ¸…æ¥šçš„èœå–®ç…§ç‰‡ï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨å³æ™‚ç¿»è­¯ä¸¦å»ºç«‹é»é¤å–®ã€‚',
                selectPhoto: 'é¸æ“‡èœå–®ç…§ç‰‡',
                takePhoto: 'æ‹ç…§',
                selectFromGallery: 'å¾ç›¸ç°¿é¸æ“‡',
                startRecognition: 'é–‹å§‹è¾¨è­˜èœå–®',
                uploadingStatus: 'æ­£åœ¨ä¸Šå‚³ä¸¦è«‹ AI è¾¨è­˜èœå–®...',
                recognitionSuccess: 'è¾¨è­˜å®Œæˆï¼æ­£åœ¨ç”Ÿæˆé»é¤ä»‹é¢...',
                recognitionError: 'è¾¨è­˜å¤±æ•—ï¼Œè«‹æ›å¼µç…§ç‰‡æˆ–ç¨å¾Œå†è©¦ã€‚',
                emptyResult: 'è¾¨è­˜çµæœç‚ºç©ºï¼Œè«‹æ›å¼µç…§ç‰‡æˆ–ç¨å¾Œå†è©¦ã€‚',
                renderError: 'èœå–®æ¸²æŸ“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æˆªåœ–çµ¦å·¥ç¨‹å¸«',
                reloadButton: 'é‡æ–°è¼‰å…¥',
                selectPhotoFirst: 'è«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡ï¼',
                
                // è³¼ç‰©è»Š
                totalLabel: 'ç¸½è¨ˆ',
                submitOrder: 'é€å‡ºè¨‚å–®',
                emptyCart: 'è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼',
                
                // è¨‚å–®ç¢ºèª
                orderConfirmed: 'è¨‚å–®å·²ç¢ºèªï¼',
                orderNumber: 'è¨‚å–®ç·¨è™Ÿ',
                totalAmount: 'ç¸½é‡‘é¡',
                orderDetails: 'è¨‚å–®å…§å®¹',
                thankYou: 'æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼Œæˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨æº–å‚™é¤é»ï¼',
                closeWindow: 'é—œé–‰è¦–çª—',
                orderSuccess: 'è¨‚å–®å·²æˆåŠŸé€å‡ºï¼',
                orderFailed: 'è¨‚å–®é€å‡ºå¤±æ•—ï¼š',
                
                // éŒ¯èª¤è¨Šæ¯
                loadMenuError: 'ç„¡æ³•è¼‰å…¥èœå–®è³‡æ–™',
                invalidPrice: 'æ²’æœ‰æœ‰æ•ˆåƒ¹æ ¼ï¼Œè«‹å…ˆç·¨è¼¯',
                noValidItems: 'æ²’æœ‰æœ‰æ•ˆçš„è¨‚å–®é …ç›®ï¼',
                orderCreateFailed: 'è¨‚å–®å»ºç«‹å¤±æ•—',
                validationFailed: 'è³‡æ–™é©—è­‰å¤±æ•—ï¼š',
                missingFields: 'ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š',
                systemBusy: 'ç³»çµ±å¿™ç¢Œï¼Œç¨å¾Œé‡è©¦',
                
                // LIFF ç‹€æ…‹è¨Šæ¯
                liffConfigError: 'è¨­å®šéŒ¯èª¤ï¼š',
                liffConfigErrorDesc: 'è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ä½ çš„ LIFF IDã€‚',
                helloUser: 'ä½ å¥½',
                liffInitSuccess: 'LIFF åˆå§‹åŒ–æˆåŠŸ (æœªç™»å…¥)',
                devMode: 'é–‹ç™¼æ¨¡å¼ï¼šLIFF æ¨¡æ“¬ç’°å¢ƒ',
                liffInitFailed: 'LIFF åˆå§‹åŒ–å¤±æ•—ã€‚'
            },
            'en-US': {
                // é é¢æ¨™é¡Œ
                pageTitle: 'Order Helper - Ordering Interface',
                appTitle: 'Order Helper',
                
                // è¼‰å…¥ç‹€æ…‹
                loadingText: 'Preparing ordering environment...',
                loadingMenu: 'Loading menu...',
                
                // èªè¨€é¡¯ç¤º
                languageDisplay: 'Display Language: ',
                languageNote: 'Language is set in LINE Bot',
                
                // åº—å®¶è³‡è¨Š
                storeLoading: 'Loading...',
                partnerStore: 'Partner Store',
                nonPartnerStore: 'Non-Partner Store',
                preparingOrder: 'Preparing ordering environment',
                
                // OCR ä»‹é¢
                ocrTitle: 'Non-Partner Store',
                ocrDescription: 'Please take or upload a clear photo of the menu. We will translate it in real-time and create an order form.',
                selectPhoto: 'Select Menu Photo',
                takePhoto: 'Take Photo',
                selectFromGallery: 'Select from Gallery',
                startRecognition: 'Start Recognition',
                uploadingStatus: 'Uploading and asking AI to recognize menu...',
                recognitionSuccess: 'Recognition complete! Generating ordering interface...',
                recognitionError: 'Recognition failed, please try a different photo or try again later.',
                emptyResult: 'Recognition result is empty, please try a different photo or try again later.',
                renderError: 'Menu rendering error, please screenshot for engineer',
                reloadButton: 'Reload',
                selectPhotoFirst: 'Please select a photo first!',
                
                // è³¼ç‰©è»Š
                totalLabel: 'Total',
                submitOrder: 'Submit Order',
                emptyCart: 'Cart is empty!',
                
                // è¨‚å–®ç¢ºèª
                orderConfirmed: 'Order Confirmed!',
                orderNumber: 'Order Number',
                totalAmount: 'Total Amount',
                orderDetails: 'Order Details',
                thankYou: 'Thank you for your order, we will prepare your meal as soon as possible!',
                closeWindow: 'Close Window',
                orderSuccess: 'Order submitted successfully!',
                orderFailed: 'Order submission failed: ',
                
                // éŒ¯èª¤è¨Šæ¯
                loadMenuError: 'Unable to load menu data',
                invalidPrice: 'No valid price, please edit first',
                noValidItems: 'No valid order items!',
                orderCreateFailed: 'Order creation failed',
                validationFailed: 'Data validation failed: ',
                missingFields: 'Missing required fields: ',
                systemBusy: 'System busy, please try again later',
                
                // LIFF ç‹€æ…‹è¨Šæ¯
                liffConfigError: 'Configuration Error: ',
                liffConfigErrorDesc: 'Please enter your LIFF ID in the code.',
                helloUser: 'Hello',
                liffInitSuccess: 'LIFF initialization successful (not logged in)',
                devMode: 'Development Mode: LIFF Simulation Environment',
                liffInitFailed: 'LIFF initialization failed.'
            },
            'ja-JP': {
                // é é¢æ¨™é¡Œ
                pageTitle: 'æ³¨æ–‡ãƒ˜ãƒ«ãƒ‘ãƒ¼ - æ³¨æ–‡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹',
                appTitle: 'æ³¨æ–‡ãƒ˜ãƒ«ãƒ‘ãƒ¼',
                
                // è¼‰å…¥ç‹€æ…‹
                loadingText: 'æ³¨æ–‡ç’°å¢ƒã‚’æº–å‚™ä¸­...',
                loadingMenu: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                
                // èªè¨€é¡¯ç¤º
                languageDisplay: 'è¡¨ç¤ºè¨€èªï¼š',
                languageNote: 'è¨€èªã¯LINE Botã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™',
                
                // åº—å®¶è³‡è¨Š
                storeLoading: 'èª­ã¿è¾¼ã¿ä¸­...',
                partnerStore: 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åº—èˆ—',
                nonPartnerStore: 'éãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åº—èˆ—',
                preparingOrder: 'æ³¨æ–‡ç’°å¢ƒã‚’æº–å‚™ä¸­',
                
                // OCR ä»‹é¢
                ocrTitle: 'éãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åº—èˆ—',
                ocrDescription: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å†™çœŸã‚’æ’®å½±ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¿»è¨³ã—ã€æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã„ãŸã—ã¾ã™ã€‚',
                selectPhoto: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†™çœŸã‚’é¸æŠ',
                takePhoto: 'å†™çœŸã‚’æ’®å½±',
                selectFromGallery: 'ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ',
                startRecognition: 'èªè­˜é–‹å§‹',
                uploadingStatus: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã€AIã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼èªè­˜ã‚’ä¾é ¼ä¸­...',
                recognitionSuccess: 'èªè­˜å®Œäº†ï¼æ³¨æ–‡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆä¸­...',
                recognitionError: 'èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å†™çœŸã‚’è©¦ã™ã‹ã€å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                emptyResult: 'èªè­˜çµæœãŒç©ºã§ã™ã€‚åˆ¥ã®å†™çœŸã‚’è©¦ã™ã‹ã€å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                renderError: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’é€ä¿¡ã—ã¦ãã ã•ã„',
                reloadButton: 'å†èª­ã¿è¾¼ã¿',
                selectPhotoFirst: 'å…ˆã«å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼',
                
                // è³¼ç‰©è»Š
                totalLabel: 'åˆè¨ˆ',
                submitOrder: 'æ³¨æ–‡é€ä¿¡',
                emptyCart: 'ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™ï¼',
                
                // è¨‚å–®ç¢ºèª
                orderConfirmed: 'æ³¨æ–‡ç¢ºèªæ¸ˆã¿ï¼',
                orderNumber: 'æ³¨æ–‡ç•ªå·',
                totalAmount: 'åˆè¨ˆé‡‘é¡',
                orderDetails: 'æ³¨æ–‡è©³ç´°',
                thankYou: 'ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã§ãã‚‹ã ã‘æ—©ããŠæ–™ç†ã‚’æº–å‚™ã„ãŸã—ã¾ã™ï¼',
                closeWindow: 'ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹',
                orderSuccess: 'æ³¨æ–‡ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼',
                orderFailed: 'æ³¨æ–‡é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š',
                
                // éŒ¯èª¤è¨Šæ¯
                loadMenuError: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“',
                invalidPrice: 'æœ‰åŠ¹ãªä¾¡æ ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç·¨é›†ã—ã¦ãã ã•ã„',
                noValidItems: 'æœ‰åŠ¹ãªæ³¨æ–‡é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ï¼',
                orderCreateFailed: 'æ³¨æ–‡ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
                validationFailed: 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼š',
                missingFields: 'å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼š',
                systemBusy: 'ã‚·ã‚¹ãƒ†ãƒ ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„',
                
                // LIFF ç‹€æ…‹è¨Šæ¯
                liffConfigError: 'è¨­å®šã‚¨ãƒ©ãƒ¼ï¼š',
                liffConfigErrorDesc: 'ã‚³ãƒ¼ãƒ‰ã«LIFF IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                helloUser: 'ã“ã‚“ã«ã¡ã¯',
                liffInitSuccess: 'LIFFåˆæœŸåŒ–æˆåŠŸï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰',
                devMode: 'é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼šLIFFã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ',
                liffInitFailed: 'LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
            },
            'ko-KR': {
                // é é¢æ¨™é¡Œ
                pageTitle: 'ì£¼ë¬¸ ë„ìš°ë¯¸ - ì£¼ë¬¸ ì¸í„°í˜ì´ìŠ¤',
                appTitle: 'ì£¼ë¬¸ ë„ìš°ë¯¸',
                
                // è¼‰å…¥ç‹€æ…‹
                loadingText: 'ì£¼ë¬¸ í™˜ê²½ì„ ì¤€ë¹„ ì¤‘...',
                loadingMenu: 'ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
                
                // èªè¨€é¡¯ç¤º
                languageDisplay: 'í‘œì‹œ ì–¸ì–´: ',
                languageNote: 'ì–¸ì–´ëŠ” LINE Botì—ì„œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤',
                
                // åº—å®¶è³‡è¨Š
                storeLoading: 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
                partnerStore: 'íŒŒíŠ¸ë„ˆ ë§¤ì¥',
                nonPartnerStore: 'ë¹„íŒŒíŠ¸ë„ˆ ë§¤ì¥',
                preparingOrder: 'ì£¼ë¬¸ í™˜ê²½ì„ ì¤€ë¹„ ì¤‘',
                
                // OCR ä»‹é¢
                ocrTitle: 'ë¹„íŒŒíŠ¸ë„ˆ ë§¤ì¥',
                ocrDescription: 'ë©”ë‰´ ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”. ì‹¤ì‹œê°„ìœ¼ë¡œ ë²ˆì—­í•˜ì—¬ ì£¼ë¬¸ ì–‘ì‹ì„ ë§Œë“¤ì–´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                selectPhoto: 'ë©”ë‰´ ì‚¬ì§„ ì„ íƒ',
                startRecognition: 'ì¸ì‹ ì‹œì‘',
                uploadingStatus: 'ì—…ë¡œë“œ ì¤‘, AIì—ê²Œ ë©”ë‰´ ì¸ì‹ì„ ìš”ì²­ ì¤‘...',
                recognitionSuccess: 'ì¸ì‹ ì™„ë£Œ! ì£¼ë¬¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì„± ì¤‘...',
                recognitionError: 'ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ì§„ì„ ì‹œë„í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
                emptyResult: 'ì¸ì‹ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ì§„ì„ ì‹œë„í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
                renderError: 'ë©”ë‰´ ë Œë”ë§ ì˜¤ë¥˜, ì—”ì§€ë‹ˆì–´ì—ê²Œ ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë‚´ ì£¼ì„¸ìš”',
                reloadButton: 'ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°',
                selectPhotoFirst: 'ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!',
                
                // è³¼ç‰©è»Š
                totalLabel: 'ì´ê³„',
                submitOrder: 'ì£¼ë¬¸ ì œì¶œ',
                emptyCart: 'ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!',
                
                // è¨‚å–®ç¢ºèª
                orderConfirmed: 'ì£¼ë¬¸ í™•ì¸ë¨!',
                orderNumber: 'ì£¼ë¬¸ ë²ˆí˜¸',
                totalAmount: 'ì´ ê¸ˆì•¡',
                orderDetails: 'ì£¼ë¬¸ ì„¸ë¶€ì‚¬í•­',
                thankYou: 'ì£¼ë¬¸í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ê°€ëŠ¥í•œ í•œ ë¹¨ë¦¬ ìŒì‹ì„ ì¤€ë¹„í•˜ê² ìŠµë‹ˆë‹¤!',
                closeWindow: 'ì°½ ë‹«ê¸°',
                orderSuccess: 'ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!',
                orderFailed: 'ì£¼ë¬¸ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ',
                
                // éŒ¯èª¤è¨Šæ¯
                loadMenuError: 'ë©”ë‰´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                invalidPrice: 'ìœ íš¨í•œ ê°€ê²©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í¸ì§‘í•´ ì£¼ì„¸ìš”',
                noValidItems: 'ìœ íš¨í•œ ì£¼ë¬¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤!',
                orderCreateFailed: 'ì£¼ë¬¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
                validationFailed: 'ë°ì´í„° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ',
                missingFields: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ',
                systemBusy: 'ì‹œìŠ¤í…œì´ í˜¼ì¡í•©ë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”',
                
                // LIFF ç‹€æ…‹è¨Šæ¯
                liffConfigError: 'ì„¤ì • ì˜¤ë¥˜: ',
                liffConfigErrorDesc: 'ì½”ë“œì— LIFF IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.',
                helloUser: 'ì•ˆë…•í•˜ì„¸ìš”',
                liffInitSuccess: 'LIFF ì´ˆê¸°í™” ì„±ê³µ (ë¡œê·¸ì¸ ì•ˆë¨)',
                devMode: 'ê°œë°œ ëª¨ë“œ: LIFF ì‹œë®¬ë ˆì´ì…˜ í™˜ê²½',
                liffInitFailed: 'LIFF ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
            }
        };

        // --- èªè¨€åˆ‡æ›å‡½æ•¸ ---
        function updateInterfaceLanguage() {
            const texts = translations[currentLanguage] || translations['zh-TW'];
            
            // æ›´æ–°é é¢æ¨™é¡Œ
            document.title = texts.pageTitle;
            
            // æ›´æ–°æ‡‰ç”¨æ¨™é¡Œ
            document.getElementById('store-name').textContent = texts.appTitle;
            
            // æ›´æ–°è¼‰å…¥æ–‡å­—
            document.querySelector('#loading p').textContent = texts.loadingText;
            
            // æ›´æ–°èªè¨€é¡¯ç¤º
            const langNames = {
                'zh-TW': 'ä¸­æ–‡',
                'en-US': 'English',
                'ja-JP': 'æ—¥æœ¬èª',
                'ko-KR': 'í•œêµ­ì–´'
            };
            const languageName = langNames[currentLanguage] || 'ä¸­æ–‡';
            document.getElementById('current-language-display').innerHTML = 
                `${texts.languageDisplay}<span id="language-name">${languageName}</span>`;
            document.querySelector('#current-language-display + p').textContent = texts.languageNote;
            
            // æ›´æ–°åº—å®¶è³‡è¨Š
            if (document.getElementById('current-store-name').textContent === 'Loading...' || 
                document.getElementById('current-store-name').textContent === 'è¼‰å…¥ä¸­...') {
                document.getElementById('current-store-name').textContent = texts.storeLoading;
            }
            
            // æ›´æ–°åº—å®¶é¡å‹æ¨™ç±¤
            if (document.getElementById('store-type-badge').textContent === 'Preparing ordering environment' ||
                document.getElementById('store-type-badge').textContent === 'æ­£åœ¨æº–å‚™é»é¤ç’°å¢ƒ') {
                document.getElementById('store-type-badge').textContent = texts.preparingOrder;
            }
            
            // æ›´æ–° OCR ä»‹é¢
            document.getElementById('ocr-title').textContent = texts.ocrTitle;
            document.getElementById('ocr-description').textContent = texts.ocrDescription;
            // æ›´æ–°çµ±ä¸€çš„ä¸Šå‚³æŒ‰éˆ•æ–‡å­—
            document.querySelector('label[for="menu-upload"]').textContent = 'ğŸ“¸ ' + texts.selectPhoto;
            document.getElementById('upload-btn').textContent = texts.startRecognition;
            
            // æ›´æ–°è³¼ç‰©è»Š
            document.getElementById('total-label').textContent = texts.totalLabel;
            document.getElementById('submit-order').textContent = texts.submitOrder;
        }


        // --- ä¸»è¦åŸ·è¡Œå‡½æ•¸ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ç­‰å¾… LIFF SDK è¼‰å…¥å®Œæˆ
            await waitForLiff();
            await initializeLiff();
            await initializeParameters();
            
            // éš±è—è®€å–ç•«é¢ï¼Œé¡¯ç¤ºä¸»å…§å®¹
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

        // ç­‰å¾… LIFF SDK è¼‰å…¥
        async function waitForLiff() {
            return new Promise((resolve) => {
                const checkLiff = () => {
                    if (typeof liff !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkLiff, 100);
                    }
                };
                checkLiff();
            });
        }

        // --- åŠŸèƒ½å‡½æ•¸ ---

        async function initializeLiff() {
            const texts = translations[currentLanguage] || translations['zh-TW'];
            
            if (LIFF_ID === 'your-liff-id') {
                const statusElement = document.getElementById('liff-status');
                statusElement.innerHTML = `<span class="text-red-600 font-bold">${texts.liffConfigError}</span><span class="text-gray-700">${texts.liffConfigErrorDesc}</span>`;
                statusElement.classList.add('bg-red-50', 'text-red-600');
                return;
            }
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­
                const isInClient = liff.isInClient();
                
                await liff.init({ 
                    liffId: LIFF_ID,
                    withLoginOnExternalBrowser: isInClient // åªåœ¨ LINE ç’°å¢ƒä¸­è¦æ±‚ç™»å…¥
                });
                console.log('LIFF init success');
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId; // å„²å­˜ LINE ä½¿ç”¨è€… ID
                    document.getElementById('liff-status').textContent = `${texts.helloUser} ${profile.displayName}ï¼`;
                    console.log('ç”¨æˆ¶è³‡æ–™:', profile);
                } else {
                    // é LIFF ç’°å¢ƒæˆ–æœªç™»å…¥æ™‚ï¼Œä½¿ç”¨è¨ªå®¢ ID
                    currentUserId = `guest_${crypto.randomUUID().slice(0, 8)}`;
                    document.getElementById('liff-status').textContent = isInClient 
                        ? texts.liffInitSuccess 
                        : texts.devMode;
                }
                liffInitialized = true;
            } catch (error) {
                console.error("LIFF Initialization failed", error);
                // é–‹ç™¼ç’°å¢ƒï¼šé¡¯ç¤ºæ¨¡æ“¬è¨Šæ¯
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('azurewebsites.net')) {
                    document.getElementById('liff-status').textContent = texts.devMode;
                } else {
                    document.getElementById('liff-status').textContent = texts.liffInitFailed;
                }
                // åˆå§‹åŒ–å¤±æ•—æ™‚ä¹Ÿè¨­å®šè¨ªå®¢ ID
                currentUserId = `guest_${crypto.randomUUID().slice(0, 8)}`;
            }
        }



                async function initializeParameters() {
            // å¾ URL åƒæ•¸å–å¾—æ‰€æœ‰å¿…è¦è³‡è¨Š
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store_id');
            const preferredLang = urlParams.get('preferred_lang'); // æ–°å¢ï¼šå¾ LINE Bot å‚³å…¥çš„ä½¿ç”¨è€…åå¥½èªè¨€
            const isPartner = urlParams.get('partner') === 'true';
            const storeName = urlParams.get('store_name') || 'Unknown Store';
            
            // èªè¨€åµæ¸¬é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨URLåƒæ•¸ï¼Œå‚™ç”¨è‡ªå‹•åµæ¸¬
            let detectedLanguage = preferredLang || urlParams.get('lang');
            
            // å¦‚æœæ²’æœ‰URLåƒæ•¸ï¼Œå˜—è©¦è‡ªå‹•åµæ¸¬LINEèªè¨€
            if (!detectedLanguage && liffInitialized) {
                try {
                    const liffLanguage = liff.getLanguage();
                    console.log('LIFFè‡ªå‹•åµæ¸¬èªè¨€:', liffLanguage);
                    detectedLanguage = liffLanguage;
                } catch (error) {
                    console.log('LIFFèªè¨€åµæ¸¬å¤±æ•—ï¼Œä½¿ç”¨ç€è¦½å™¨èªè¨€');
                    // å‚™ç”¨ï¼šä½¿ç”¨ç€è¦½å™¨èªè¨€
                    detectedLanguage = navigator.language || 'zh-TW';
                }
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æœ‰èªè¨€è¨­å®šï¼Œä½¿ç”¨é è¨­å€¼
            const language = detectedLanguage || 'zh-TW';
            
            // èªè¨€ä»£ç¢¼è½‰æ›ï¼šå°‡ç°¡çŸ­ä»£ç¢¼è½‰æ›ç‚ºå®Œæ•´ä»£ç¢¼
            const languageCodeMapping = {
                'en': 'en-US',
                'zh-TW': 'zh-TW', 
                'ja': 'ja-JP',
                'ko': 'ko-KR',
                'zh': 'zh-TW',  // æ”¯æ´ç°¡é«”ä¸­æ–‡è½‰ç¹é«”
                'en-US': 'en-US',
                'ja-JP': 'ja-JP',
                'ko-KR': 'ko-KR'
            };
            const normalizedLanguage = languageCodeMapping[language] || 'zh-TW';
            
            // è¨­å®šå…¨å±€è®Šæ•¸
            currentStore = storeId || 'non-partner';
            currentLanguage = normalizedLanguage;
            
            // é™¤éŒ¯ï¼šé¡¯ç¤ºèªè¨€åµæ¸¬éç¨‹
            console.log('èªè¨€åµæ¸¬éç¨‹:', {
                store_id: storeId,
                preferred_lang: preferredLang,
                detected_language: detectedLanguage,
                original_language: language,
                normalized_language: normalizedLanguage,
                liff_initialized: liffInitialized,
                browser_language: navigator.language,
                isPartner: isPartner,
                storeName: storeName,
                currentStore: currentStore
            });
            
            // ç›´æ¥é¡¯ç¤ºåº—å®¶è³‡è¨Šï¼ˆå¾Œç«¯æœƒè™•ç†ç¿»è­¯ï¼‰
            document.getElementById('current-store-name').textContent = storeName;
            const texts = translations[currentLanguage] || translations['zh-TW'];
            document.getElementById('store-type-badge').innerHTML = isPartner 
                ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${texts.partnerStore}</span>`
                : `<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">${texts.nonPartnerStore}</span>`;
            
            // æ›´æ–°èªè¨€é¡¯ç¤º
            updateLanguageDisplay();
            updateLanguageInfo();
            
            // æ›´æ–°ä»‹é¢èªè¨€
            updateInterfaceLanguage();
            
            // æ ¹æ“šåˆä½œç‹€æ…‹æ±ºå®šé¡¯ç¤ºä»‹é¢
            if (isPartner) {
                // åˆä½œåº—å®¶æ¨¡å¼ - ç›´æ¥è¼‰å…¥èœå–®
                await loadPartnerStoreMenu(storeId, normalizedLanguage);
            } else {
                // éåˆä½œåº—å®¶æ¨¡å¼ - é¡¯ç¤º OCR ä¸Šå‚³ä»‹é¢
                showNonPartnerInterface();
            }
        }

        function updateLanguageDisplay() {
            const langNames = {
                'zh-TW': 'ä¸­æ–‡',
                'en-US': 'English',
                'ja-JP': 'æ—¥æœ¬èª',
                'ko-KR': 'í•œêµ­ì–´'
            };
            
            const languageName = langNames[currentLanguage] || 'ä¸­æ–‡';
            document.getElementById('language-name').textContent = languageName;
            
            // æ›´æ–°èªè¨€è³‡è¨Š
            updateLanguageInfo();
        }

        function updateLanguageInfo() {
            const langNames = {
                'zh-TW': 'ä¸­æ–‡',
                'en-US': 'English',
                'ja-JP': 'æ—¥æœ¬èª',
                'ko-KR': 'í•œêµ­ì–´'
            };
            const languageName = langNames[currentLanguage] || 'ä¸­æ–‡';
            const texts = translations[currentLanguage] || translations['zh-TW'];
            document.getElementById('lang-info').textContent = 
                `Store ID: ${currentStore || 'Not Selected'} / Language: ${languageName}`;
        }



        async function loadPartnerStoreMenu(storeId, language) {
            try {
                // éš±è— OCR ä»‹é¢
                document.getElementById('ocr-section').classList.add('hidden');
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const menuList = document.getElementById('menu-list');
                const texts = translations[currentLanguage] || translations['zh-TW'];
                menuList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">${texts.loadingMenu}</p>
                    </div>
                `;
                
                // èªè¨€ä»£ç¢¼è½‰æ›ï¼šå°‡å®Œæ•´ä»£ç¢¼è½‰æ›ç‚ºå¾Œç«¯æœŸæœ›çš„ç°¡çŸ­ä»£ç¢¼
                const backendLanguageMapping = {
                    'en-US': 'en',
                    'zh-TW': 'zh',
                    'ja-JP': 'ja',
                    'ko-KR': 'ko'
                };
                const backendLanguage = backendLanguageMapping[language] || language;
                
                // å‘å¾Œç«¯è«‹æ±‚èœå–®è³‡æ–™
                const response = await fetch(`${API_BASE_URL}/api/menu/${storeId}?lang=${backendLanguage}`);
                if (!response.ok) {
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    throw new Error(texts.loadMenuError);
                }
                const data = await response.json();
                
                // æ¸²æŸ“èœå–®
                if (data && data.items && data.items.length > 0) {
                    try {
                        renderMenu(data.items);
                    } catch (renderError) {
                        console.error('å‰ç«¯æ¸²æŸ“éŒ¯èª¤:', renderError);
                        const texts = translations[currentLanguage] || translations['zh-TW'];
                        menuList.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-red-600 mb-4">${texts.renderError}</p>
                                <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                    ${texts.reloadButton}
                                </button>
                            </div>
                        `;
                    }
                } else {
                    // å¦‚æœæ²’æœ‰èœå–®è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    menuList.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-600 mb-4">${texts.loadMenuError}</p>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                ${texts.reloadButton}
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥åˆä½œåº—å®¶èœå–®å¤±æ•—:', error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                const texts = translations[currentLanguage] || translations['zh-TW'];
                menuList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-600 mb-4">${texts.loadMenuError}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                            ${texts.reloadButton}
                        </button>
                    </div>
                `;
            }
        }

        function showNonPartnerInterface() {
            // é¡¯ç¤ºéåˆä½œåº—å®¶ä»‹é¢
            document.getElementById('ocr-section').classList.remove('hidden');
            
            // åˆå§‹åŒ–éåˆä½œåº—å®¶æ¨¡å¼
            setupNonPartnerMode();
        }

        function setupNonPartnerMode() {
            const fileInput = document.getElementById('menu-upload');
            const uploadBtn = document.getElementById('upload-btn');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            // è™•ç†æª”æ¡ˆé¸æ“‡çš„é€šç”¨å‡½æ•¸
            function handleFileSelect(file) {
                if (file) {
                    previewImage.src = URL.createObjectURL(file);
                    previewContainer.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                    
                    // å„²å­˜é¸æ“‡çš„æª”æ¡ˆåˆ°å…¨åŸŸè®Šæ•¸
                    window.selectedFile = file;
                }
            }

            // ç‚ºæª”æ¡ˆä¸Šå‚³ input æ·»åŠ äº‹ä»¶ç›£è½å™¨
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFileSelect(file);
            });

            uploadBtn.addEventListener('click', async () => {
                const file = window.selectedFile;
                if (!file) {
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    alert(texts.selectPhotoFirst);
                    return;
                }
                
                // å£“ç¸®åœ–ç‰‡
                const compressedFile = await compress(file);
                await handleOcrUpload(compressedFile, currentLanguage);
            });
        }

        // åœ–ç‰‡å£“ç¸®å‡½æ•¸ (å„ªåŒ–ç‰ˆ)
        function compress(imgFile) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 1024 / Math.max(img.width, img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(b => {
                        const compressedFile = new File([b], imgFile.name, {type:'image/jpeg'});
                        console.log('åœ–ç‰‡å£“ç¸®å®Œæˆ:', {
                            åŸå§‹å¤§å°: imgFile.size,
                            å£“ç¸®å¾Œå¤§å°: compressedFile.size,
                            å£“ç¸®æ¯”ä¾‹: Math.round((1 - compressedFile.size / imgFile.size) * 100) + '%',
                            æ–°å°ºå¯¸: `${canvas.width}Ã—${canvas.height}`
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', 0.85);
                };
                img.src = URL.createObjectURL(imgFile);
            });
        }

        async function handleOcrUpload(file, language) {
            const ocrStatus = document.getElementById('ocr-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            // é¡¯ç¤ºè™•ç†ç‹€æ…‹
            const texts = translations[currentLanguage] || translations['zh-TW'];
            ocrStatus.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>${texts.uploadingStatus}</span>
                </div>
            `;
            ocrStatus.classList.remove('hidden');
            uploadBtn.disabled = true;

            try {
                // æª¢æŸ¥ä¸¦ç¢ºä¿ store_id æœ‰æœ‰æ•ˆå€¼
                const storeId = currentStore || 'non-partner';
                console.log('å³å°‡ä¸Šå‚³ store_id:', storeId);
                
                // èªè¨€ä»£ç¢¼è½‰æ›ï¼šå°‡å®Œæ•´ä»£ç¢¼è½‰æ›ç‚ºå¾Œç«¯æœŸæœ›çš„ç°¡çŸ­ä»£ç¢¼
                const backendLanguageMapping = {
                    'en-US': 'en',
                    'zh-TW': 'zh',
                    'ja-JP': 'ja',
                    'ko-KR': 'ko'
                };
                const backendLanguage = backendLanguageMapping[language] || language;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('lang', backendLanguage);
                formData.append('store_id', storeId);
                
                // debug: dump every key/val
                console.log('FormData å…§å®¹:');
                for (let [k,v] of formData.entries()) {
                    console.log(`â†’ ${k}:`, v);
                }
                
                console.log('æº–å‚™ä¸Šå‚³æª”æ¡ˆ:', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    language: language,
                    storeId: storeId
                });
                
                const response = await fetch(`${API_BASE_URL}/api/upload-menu-image`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('API å›æ‡‰ç‹€æ…‹:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API éŒ¯èª¤å›æ‡‰:', errorData);
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    throw new Error(errorData.error || `${texts.systemBusy} (${response.status})`);
                }
                
                // 201 Created ä¹Ÿæ˜¯æˆåŠŸç‹€æ…‹
                console.log('API å‘¼å«æˆåŠŸ:', response.status);
                
                const data = await response.json();
                console.log('å¾Œç«¯å›å‚³çš„å®Œæ•´è³‡æ–™:', data);
                
                // æª¢æŸ¥è³‡æ–™çµæ§‹
                if (data.menu_items) {
                    console.log('menu_items å­˜åœ¨:', data.menu_items);
                    console.log('items æ•¸é‡:', data.menu_items.length);
                } else {
                    console.log('menu_items ä¸å­˜åœ¨ï¼Œæª¢æŸ¥å…¶ä»–å¯èƒ½çš„æ¬„ä½');
                    console.log('å¯ç”¨çš„æ¬„ä½:', Object.keys(data));
                }
                
                // é¡¯ç¤ºæˆåŠŸç‹€æ…‹
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-green-600">
                        <span class="text-xl">âœ…</span>
                        <span>${texts.recognitionSuccess}</span>
                    </div>
                `;
                setTimeout(() => ocrStatus.classList.add('hidden'), 2000);
                
                // æ¸²æŸ“è¾¨è­˜çµæœ
                if (data.menu_items && data.menu_items.length > 0) {
                    try {
                        renderMenu(data.menu_items);
                        // æ¸²æŸ“æˆåŠŸï¼Œéš±è—ç‹€æ…‹è¨Šæ¯
                        setTimeout(() => ocrStatus.classList.add('hidden'), 2000);
                    } catch (renderError) {
                        console.error('å‰ç«¯æ¸²æŸ“éŒ¯èª¤:', renderError);
                        ocrStatus.innerHTML = `
                            <div class="flex items-center justify-center space-x-2 text-red-600">
                                <span class="text-xl">âš ï¸</span>
                                <span>${texts.renderError}</span>
                            </div>
                        `;
                    }
                } else {
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    ocrStatus.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 text-red-600">
                            <span class="text-xl">âŒ</span>
                            <span>${texts.emptyResult}</span>
                        </div>
                    `;
                }

            } catch (error) {
                console.error("OCR è™•ç†å¤±æ•—:", error);
                ocrStatus.innerHTML = `
                    <div class="flex items-center justify-center space-x-2 text-red-600">
                        <span class="text-xl">âŒ</span>
                        <span>${texts.recognitionError}</span>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function renderMenu(items) {
            currentMenuItems = items;
            const menuList = document.getElementById('menu-list');
            menuList.innerHTML = '';
            
            items.forEach(item => {
                const element = createMenuItemElement(item);
                if (element) {
                    menuList.appendChild(element);
                }
            });
            
            document.getElementById('cart-footer').classList.remove('hidden');
        }

        function createMenuItemElement(item) {
            // å®‰å…¨è™•ç†å¯èƒ½ç‚ºç©ºçš„æ¬„ä½
            const safeStr = (value) => (value ?? '').toString();
            const safeNum = (value) => {
                if (value === null || value === undefined) return 0;
                const num = Number(value);
                return isNaN(num) ? 0 : num;
            };
            
            // æ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
            const texts = translations[currentLanguage] || translations['zh-TW'];
            const itemName = safeStr(item.translated_name || item.original_name || item.item_name || 'Untitled');
            const description = safeStr(item.description || '');
            const price = safeNum(item.price || item.price_small || 0);
            const itemId = item.id || item.menu_item_id || item.temp_id || `temp_${Date.now()}_${Math.random()}`;
            
            // é©—è­‰å¿…è¦æ¬„ä½ - åªè¦æœ‰åç¨±å’Œåƒ¹æ ¼å°±é¡¯ç¤º
            if (!itemName || itemName === 'Untitled' || itemName === 'æœªå‘½å') {
                console.warn('èœå–®é …ç›®ç¼ºå°‘åç¨±ï¼Œç•¥éæ­¤é …:', item);
                return null;
            }
            
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-md flex items-center space-x-4';
            div.innerHTML = `
                <div class="w-16 h-16 bg-gray-200 rounded-md flex-shrink-0">
                    <img src="https://placehold.co/64x64/e2e8f0/334155?text=${itemName.charAt(0) || 'ğŸ½ï¸'}" class="w-full h-full object-cover rounded-md" alt="${itemName}">
                </div>
                <div class="flex-grow">
                    <h3 class="font-bold text-lg text-gray-800">${itemName}</h3>
                    <p class="text-sm text-gray-500">${description}</p>
                    <p class="text-md font-semibold text-blue-600 mt-1">NT$ ${price}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button data-item-id="${itemId}" class="decrease-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-full font-bold text-lg hover:bg-gray-300 transition">-</button>
                    <span id="quantity-${itemId}" class="font-bold text-lg w-6 text-center">0</span>
                    <button data-item-id="${itemId}" class="increase-btn bg-blue-500 text-white w-8 h-8 rounded-full font-bold text-lg hover:bg-blue-600 transition">+</button>
                </div>
            `;
            div.querySelector('.increase-btn').addEventListener('click', () => updateCart(item, 1));
            div.querySelector('.decrease-btn').addEventListener('click', () => updateCart(item, -1));
            return div;
        }

        function updateCart(item, change) {
            // ä½¿ç”¨èˆ‡ createMenuItemElement ç›¸åŒçš„é‚è¼¯ä¾†å–å¾— itemId
            const itemId = item.id || item.menu_item_id || item.temp_id || `temp_${Date.now()}_${Math.random()}`;
            const currentQuantity = cart[itemId] || 0;
            const newQuantity = Math.max(0, currentQuantity + change);
            cart[itemId] = newQuantity;
            document.getElementById(`quantity-${itemId}`).textContent = newQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            let total = 0;
            for (const itemId in cart) {
                const quantity = cart[itemId];
                if (quantity > 0) {
                    // ä½¿ç”¨å¤šç¨®å¯èƒ½çš„ ID æ¬„ä½ä¾†åŒ¹é…é …ç›®
                    const item = currentMenuItems.find(i => 
                        (i.id == itemId) || 
                        (i.menu_item_id == itemId) || 
                        (i.temp_id == itemId)
                    );
                    if (item) {
                        // å®‰å…¨è™•ç†åƒ¹æ ¼
                        const safeNum = (value) => {
                            if (value === null || value === undefined) return 0;
                            const num = Number(value);
                            return isNaN(num) ? 0 : num;
                        };
                        const price = safeNum(item.price || item.price_small || 0);
                        total += price * quantity;
                    }
                }
            }
            document.getElementById('total-price').textContent = total;
            document.getElementById('submit-order').disabled = total === 0;
        }

        function showOrderConfirmation(result, orderDetails) {
            const mainContent = document.getElementById('main-content');
            const cartFooter = document.getElementById('cart-footer');
            const texts = translations[currentLanguage] || translations['zh-TW'];
            
            // éš±è—è³¼ç‰©è»Š
            cartFooter.classList.add('hidden');
            
            // é¡¯ç¤ºç¢ºèªé é¢
            mainContent.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-6xl mb-4">âœ…</div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">${texts.orderConfirmed}</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <p class="text-lg font-semibold text-gray-700 mb-4">ğŸ“‹ ${texts.orderNumber}: ${result.order_id}</p>
                        <p class="text-lg font-semibold text-blue-600 mb-4">ğŸ’° ${texts.totalAmount}: NT$ ${document.getElementById('total-price').textContent}</p>
                        <div class="text-left bg-gray-50 p-4 rounded-md mb-4">
                            <p class="font-semibold text-gray-700 mb-2">ğŸ“ ${texts.orderDetails}:</p>
                            <p class="text-sm text-gray-600 whitespace-pre-line">${orderDetails}</p>
                        </div>
                        <p class="text-gray-600">${texts.thankYou}</p>
                    </div>
                    <button onclick="closeLiffWindow()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        ${texts.closeWindow}
                    </button>
                </div>
            `;
        }

        function closeLiffWindow() {
            if (liffInitialized && liff.isLoggedIn()) {
                liff.closeWindow();
            } else {
                // å¦‚æœä¸åœ¨ LIFF ç’°å¢ƒä¸­ï¼Œé¡¯ç¤ºä¸€èˆ¬è¨Šæ¯
                const texts = translations[currentLanguage] || translations['zh-TW'];
                alert(texts.orderSuccess);
            }
        }

        document.getElementById('submit-order').addEventListener('click', async () => {
            if (Object.keys(cart).length === 0 || Object.values(cart).every(q => q === 0)) {
                const texts = translations[currentLanguage] || translations['zh-TW'];
                alert(texts.emptyCart);
                return;
            }
            
            try {
                // 1. é©—è­‰è³¼ç‰©è»Šè³‡æ–™
                const cartItems = Object.entries(cart)
                    .filter(([_, quantity]) => quantity > 0);
                
                if (cartItems.length === 0) {
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    alert(texts.emptyCart);
                    return;
                }
                
                // 2. å»ºç«‹è¨‚å–®é …ç›®ï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼Œèˆ‡å¾Œç«¯ç›¸å®¹ï¼‰
                let totalAmount = 0;
                const orderItems = cartItems.map(([itemId, quantity]) => {
                    // ä½¿ç”¨å¤šç¨®å¯èƒ½çš„ ID æ¬„ä½ä¾†åŒ¹é…é …ç›®
                    const item = currentMenuItems.find(i => 
                        (i.id == itemId) || 
                        (i.menu_item_id == itemId) || 
                        (i.temp_id == itemId)
                    );
                    
                    if (!item) {
                        console.warn('æ‰¾ä¸åˆ°èœå–®é …ç›®:', itemId);
                        return null;
                    }
                    
                    // å®‰å…¨è™•ç†åƒ¹æ ¼ï¼ˆæ”¯æ´å¤šç¨®åƒ¹æ ¼æ¬„ä½ï¼‰
                    const safeNum = (value) => {
                        if (value === null || value === undefined) return 0;
                        const num = Number(value);
                        return isNaN(num) ? 0 : num;
                    };
                    const priceUnit = safeNum(item.price_small || item.price || item.price_unit || 0);
                    if (priceUnit <= 0) {
                        console.error('åƒ¹æ ¼ç„¡æ•ˆ:', item);
                        const texts = translations[currentLanguage] || translations['zh-TW'];
                        const itemName = item.translated_name || item.original_name || item.item_name || 'Item';
                        alert(`${itemName} ${texts.invalidPrice}`);
                        throw new Error('Invalid price');
                    }
                    
                    // é©—è­‰æ•¸é‡
                    if (!quantity || quantity <= 0) {
                        console.warn('æ•¸é‡ç„¡æ•ˆ:', quantity);
                        return null;
                    }
                    
                    const itemTotal = priceUnit * quantity;
                    totalAmount += itemTotal;
                    
                    // è¿”å›è¨‚å–®é …ç›®ï¼ˆæ”¯æ´å¤šç¨®æ¬„ä½åç¨±æ ¼å¼ï¼‰
                    return {
                        // æ”¯æ´å¤šç¨® ID æ ¼å¼
                        menu_item_id: item.menu_item_id || item.id || item.temp_id,
                        // æ”¯æ´å¤šç¨®æ•¸é‡æ¬„ä½åç¨±
                        quantity: quantity,  // å¾Œç«¯ä¹Ÿæ”¯æ´ qty
                        qty: quantity,      // å¾Œç«¯ä¹Ÿæ”¯æ´ quantity
                        // æ”¯æ´å¤šç¨®åƒ¹æ ¼æ¬„ä½åç¨±
                        price_unit: priceUnit,  // å¾Œç«¯ä¹Ÿæ”¯æ´ price æˆ– price_small
                        price: priceUnit,       // å¾Œç«¯ä¹Ÿæ”¯æ´ price_unit
                        // é¡å¤–è³‡è¨Šï¼ˆå¯é¸ï¼‰
                        item_name: item.translated_name || item.original_name || item.item_name,
                        subtotal: itemTotal
                    };
                }).filter(Boolean); // éæ¿¾æ‰ç„¡æ•ˆé …ç›®

                if (orderItems.length === 0) {
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    alert(texts.noValidItems);
                    return;
                }

                // 3. æº–å‚™è«‹æ±‚è³‡æ–™ï¼ˆèˆ‡å¾Œç«¯å®Œå…¨ç›¸å®¹ï¼‰
                const payload = {
                    line_user_id: currentUserId, // åŠ å…¥ä½¿ç”¨è€… ID
                    store_id: currentStore || 'non-partner',
                    items: orderItems,
                    total: totalAmount,  // å¯é¸ï¼Œå¾Œç«¯æœƒé‡æ–°è¨ˆç®—
                    language: currentLanguage
                };

                console.log('ç™¼é€è¨‚å–® payload:', payload);

                // 4. ç™¼é€è«‹æ±‚
                const response = await fetch(`${API_BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                // 5. è™•ç†å›æ‡‰ï¼ˆæ”¹å–„éŒ¯èª¤è™•ç†ï¼‰
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('å¾Œç«¯éŒ¯èª¤å›æ‡‰:', errorData);
                    
                    // é¡¯ç¤ºè©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                    const texts = translations[currentLanguage] || translations['zh-TW'];
                    let errorMessage = texts.orderCreateFailed;
                    if (errorData.validation_errors) {
                        errorMessage = `${texts.validationFailed}\n${errorData.validation_errors.join('\n')}`;
                    } else if (errorData.missing_fields) {
                        errorMessage = `${texts.missingFields}${errorData.missing_fields.join(', ')}`;
                    } else if (errorData.detail) {
                        errorMessage = errorData.detail;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else {
                        errorMessage = `${response.statusText} (${response.status})`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                const orderDetails = orderItems
                    .map(item => {
                        // ä½¿ç”¨å¤šç¨®å¯èƒ½çš„ ID æ¬„ä½ä¾†åŒ¹é…é …ç›®
                        const menuItem = currentMenuItems.find(i => 
                            (i.id == item.menu_item_id) || 
                            (i.menu_item_id == item.menu_item_id) || 
                            (i.temp_id == item.menu_item_id)
                        );
                        if (menuItem) {
                            const itemName = menuItem.translated_name || menuItem.original_name || menuItem.item_name || 'Untitled';
                            return `${itemName} x ${item.qty}`;
                        }
                        const texts = translations[currentLanguage] || translations['zh-TW'];
                        return `Item ${item.menu_item_id} x ${item.qty}`;
                    }).join('\n');

                // é¡¯ç¤ºè¨‚å–®ç¢ºèªé é¢
                showOrderConfirmation(result, orderDetails);
                
                // æ¸…ç©ºè³¼ç‰©è»Š
                cart = {};
                currentMenuItems.forEach(item => {
                    const itemId = item.id || item.menu_item_id || item.temp_id;
                    const quantityElement = document.getElementById(`quantity-${itemId}`);
                    if (quantityElement) {
                        quantityElement.textContent = '0';
                    }
                });
                updateTotalPrice();
                
            } catch (error) {
                console.error('é€å‡ºè¨‚å–®å¤±æ•—:', error);
                const texts = translations[currentLanguage] || translations['zh-TW'];
                alert(`${texts.orderFailed}${error.message}`);
            }
        });
    </script>

</body>
</html> 
