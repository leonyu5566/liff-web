<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF 點餐網頁 - 本地測試</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        button:focus { outline: none; }
        input[type="file"] { display: none; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-lg p-4">
        <!-- 測試控制面板 -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">LIFF 點餐網頁測試</h1>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">後端 API 網址</label>
                    <input type="text" id="api-url" value="http://localhost:3001" 
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">店家 ID</label>
                        <input type="text" id="store-id" value="1" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">店家名稱</label>
                        <input type="text" id="store-name" value="王阿嬤臭豆腐" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">語言</label>
                        <select id="language" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="zh-TW">中文</option>
                            <option value="en-US">English</option>
                            <option value="ja-JP">日本語</option>
                            <option value="ko-KR">한국어</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">合作狀態</label>
                        <select id="partner-status" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="true">合作店家</option>
                            <option value="false">非合作店家</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button id="test-partner" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        測試合作店家
                    </button>
                    <button id="test-non-partner" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                        測試非合作店家
                    </button>
                </div>
            </div>
        </div>

        <!-- 測試結果顯示 -->
        <div id="test-results" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4">測試結果</h2>
            <div id="results-content" class="space-y-4">
                <!-- 測試結果將在這裡顯示 -->
            </div>
        </div>

        <!-- LIFF 網頁預覽 -->
        <div id="liff-preview" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4">LIFF 網頁預覽</h2>
            <iframe id="liff-frame" src="index.html" class="w-full h-96 border border-gray-300 rounded-lg"></iframe>
        </div>
    </div>

    <script>
        // 測試控制邏輯
        document.getElementById('test-partner').addEventListener('click', () => {
            const params = getTestParameters();
            params.partner = 'true';
            runTest(params);
        });

        document.getElementById('test-non-partner').addEventListener('click', () => {
            const params = getTestParameters();
            params.partner = 'false';
            runTest(params);
        });

        function getTestParameters() {
            return {
                apiUrl: document.getElementById('api-url').value,
                storeId: document.getElementById('store-id').value,
                storeName: document.getElementById('store-name').value,
                language: document.getElementById('language').value,
                partner: document.getElementById('partner-status').value
            };
        }

        async function runTest(params) {
            const resultsDiv = document.getElementById('test-results');
            const contentDiv = document.getElementById('results-content');
            
            // 顯示測試結果區域
            resultsDiv.classList.remove('hidden');
            
            // 清空之前的結果
            contentDiv.innerHTML = '<div class="animate-pulse">正在測試...</div>';
            
            const results = [];
            
            try {
                // 測試 1: 檢查後端連線
                results.push(await testBackendConnection(params.apiUrl));
                
                // 測試 2: 測試合作店家 API
                if (params.partner === 'true') {
                    results.push(await testPartnerStoreAPI(params));
                }
                
                // 測試 3: 測試非合作店家 API
                if (params.partner === 'false') {
                    results.push(await testNonPartnerStoreAPI(params));
                }
                
                // 測試 4: 更新 LIFF 預覽
                updateLiffPreview(params);
                results.push({
                    name: 'LIFF 預覽更新',
                    status: 'success',
                    message: '已更新 LIFF 網頁預覽'
                });
                
            } catch (error) {
                results.push({
                    name: '測試執行',
                    status: 'error',
                    message: `測試執行失敗: ${error.message}`
                });
            }
            
            // 顯示結果
            displayResults(results);
        }

        async function testBackendConnection(apiUrl) {
            try {
                const response = await fetch(`${apiUrl}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    return {
                        name: '後端連線測試',
                        status: 'success',
                        message: '後端服務正常運作'
                    };
                } else {
                    return {
                        name: '後端連線測試',
                        status: 'error',
                        message: `後端回應錯誤: ${response.status} ${response.statusText}`
                    };
                }
            } catch (error) {
                return {
                    name: '後端連線測試',
                    status: 'error',
                    message: `連線失敗: ${error.message}`
                };
            }
        }

        async function testPartnerStoreAPI(params) {
            try {
                const response = await fetch(`${params.apiUrl}/api/menus/${params.storeId}?lang=${params.language}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        name: '合作店家菜單 API',
                        status: 'success',
                        message: `成功載入菜單，共 ${data.items?.length || 0} 個項目`
                    };
                } else {
                    return {
                        name: '合作店家菜單 API',
                        status: 'error',
                        message: `API 回應錯誤: ${response.status} ${response.statusText}`
                    };
                }
            } catch (error) {
                return {
                    name: '合作店家菜單 API',
                    status: 'error',
                    message: `API 呼叫失敗: ${error.message}`
                };
            }
        }

        async function testNonPartnerStoreAPI(params) {
            try {
                // 建立一個測試用的圖片檔案
                const testImage = new File(['test'], 'test.jpg', { type: 'image/jpeg' });
                const formData = new FormData();
                formData.append('image', testImage);
                formData.append('lang', params.language);
                formData.append('store_id', params.storeId);
                
                const response = await fetch(`${params.apiUrl}/api/upload-menu-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    return {
                        name: '非合作店家 OCR API',
                        status: 'success',
                        message: 'OCR API 端點正常'
                    };
                } else {
                    return {
                        name: '非合作店家 OCR API',
                        status: 'error',
                        message: `OCR API 回應錯誤: ${response.status} ${response.statusText}`
                    };
                }
            } catch (error) {
                return {
                    name: '非合作店家 OCR API',
                    status: 'error',
                    message: `OCR API 呼叫失敗: ${error.message}`
                };
            }
        }

        function updateLiffPreview(params) {
            const iframe = document.getElementById('liff-frame');
            const url = new URL('index.html', window.location.href);
            url.searchParams.set('store_id', params.storeId);
            url.searchParams.set('store_name', params.storeName);
            url.searchParams.set('lang', params.language);
            url.searchParams.set('partner', params.partner);
            
            iframe.src = url.toString();
        }

        function displayResults(results) {
            const contentDiv = document.getElementById('results-content');
            contentDiv.innerHTML = '';
            
            results.forEach(result => {
                const statusColor = result.status === 'success' ? 'text-green-600' : 'text-red-600';
                const statusIcon = result.status === 'success' ? '✅' : '❌';
                
                const resultElement = document.createElement('div');
                resultElement.className = 'p-4 border border-gray-200 rounded-lg';
                resultElement.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">${statusIcon}</span>
                        <h3 class="font-semibold ${statusColor}">${result.name}</h3>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${result.message}</p>
                `;
                
                contentDiv.appendChild(resultElement);
            });
        }
    </script>

</body>
</html> 