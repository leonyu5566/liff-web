<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Bot 整合測試 - 店家資訊到點餐系統</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .test-step { transition: all 0.3s ease; }
        .test-step.active { background-color: #f0f9ff; border-color: #3b82f6; }
        .test-step.success { background-color: #f0fdf4; border-color: #22c55e; }
        .test-step.error { background-color: #fef2f2; border-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-4xl p-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">LINE Bot 整合測試</h1>
        <p class="text-center text-gray-600 mb-8">測試從 LINE Bot 接收店家資訊到呼叫後端菜單和點餐系統的完整流程</p>
        
        <!-- 測試控制面板 -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">測試設定</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 模擬 LINE Bot 資料 -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">模擬 LINE Bot 傳入資料</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">店家 ID</label>
                            <select id="store-id" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="1">1 - 王阿嬤臭豆腐 (合作店家)</option>
                                <option value="2">2 - 小李牛肉麵 (合作店家)</option>
                                <option value="3">3 - 阿婆滷肉飯 (合作店家)</option>
                                <option value="999">999 - 非合作店家 (OCR 模式)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">語言設定</label>
                            <select id="language" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="zh-TW">中文</option>
                                <option value="en-US">English</option>
                                <option value="ja-JP">日本語</option>
                                <option value="ko-KR">한국어</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">LIFF 狀態</label>
                            <select id="liff-status" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="true">已初始化</option>
                                <option value="false">未初始化</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 後端設定 -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">後端 API 設定</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">API 基礎 URL</label>
                            <input type="text" id="api-base-url" value="http://localhost:3001" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">測試模式</label>
                            <select id="test-mode" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="real">真實 API 呼叫</option>
                                <option value="mock">模擬資料</option>
                            </select>
                        </div>
                        
                        <button id="test-backend" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            測試後端連線
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 測試步驟 -->
        <div class="space-y-4 mb-6">
            <div id="step-1" class="test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">步驟 1: 接收 LINE Bot 店家資訊</h3>
                <div class="text-sm text-gray-600 mb-3">
                    <p>模擬從 LINE Bot 接收到的店家資訊和語言設定</p>
                </div>
                <div id="step-1-content" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p><strong>店家 ID:</strong> <span id="received-store-id"></span></p>
                        <p><strong>語言:</strong> <span id="received-language"></span></p>
                        <p><strong>LIFF 狀態:</strong> <span id="received-liff-status"></span></p>
                    </div>
                </div>
            </div>

            <div id="step-2" class="test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">步驟 2: 呼叫後端菜單 API</h3>
                <div class="text-sm text-gray-600 mb-3">
                    <p>向後端請求店家菜單資料</p>
                </div>
                <div id="step-2-content" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p><strong>API 呼叫:</strong> <span id="menu-api-call"></span></p>
                        <p><strong>回應狀態:</strong> <span id="menu-response-status"></span></p>
                        <div id="menu-data" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <div id="step-3" class="test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">步驟 3: 渲染菜單介面</h3>
                <div class="text-sm text-gray-600 mb-3">
                    <p>將菜單資料渲染成點餐介面</p>
                </div>
                <div id="step-3-content" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p><strong>菜單項目數量:</strong> <span id="menu-items-count"></span></p>
                        <div id="menu-preview" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <div id="step-4" class="test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">步驟 4: 模擬點餐操作</h3>
                <div class="text-sm text-gray-600 mb-3">
                    <p>模擬用戶選擇餐點並加入購物車</p>
                </div>
                <div id="step-4-content" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div id="order-simulation" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="step-5" class="test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">步驟 5: 送出訂單到後端</h3>
                <div class="text-sm text-gray-600 mb-3">
                    <p>將訂單資料傳送到後端 API</p>
                </div>
                <div id="step-5-content" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p><strong>訂單 API 呼叫:</strong> <span id="order-api-call"></span></p>
                        <p><strong>訂單回應狀態:</strong> <span id="order-response-status"></span></p>
                        <div id="order-result" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 開始測試按鈕 -->
        <div class="text-center">
            <button id="start-test" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors text-lg font-semibold">
                開始完整測試流程
            </button>
        </div>

        <!-- 測試結果摘要 -->
        <div id="test-summary" class="bg-white p-6 rounded-lg shadow-md mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">測試結果摘要</h2>
            <div id="summary-content" class="space-y-2">
                <!-- 測試結果將在這裡顯示 -->
            </div>
        </div>
    </div>

    <script>
        // 模擬資料
        const MOCK_MENU_DATA = {
            "zh-TW": {
                "store_name": "王阿嬤臭豆腐",
                "items": [
                    { "menu_item_id": 101, "item_name": "招牌臭豆腐", "description": "外酥內嫩的發酵豆腐，搭配特製泡菜。", "price_small": 60 },
                    { "menu_item_id": 102, "item_name": "珍珠奶茶", "description": "經典台灣手搖飲，Q彈珍珠搭配香濃奶茶。", "price_small": 50 },
                    { "menu_item_id": 103, "item_name": "滷肉飯", "description": "香濃滷肉配白飯，經典台灣小吃。", "price_small": 80 }
                ]
            },
            "en-US": {
                "store_name": "Grandma Wang's Stinky Tofu",
                "items": [
                    { "menu_item_id": 101, "item_name": "Crispy Stinky Tofu", "description": "Fermented tofu deep-fried to golden perfection.", "price_small": 60 },
                    { "menu_item_id": 102, "item_name": "Bubble Milk Tea", "description": "Classic Taiwanese milk tea with tapioca pearls.", "price_small": 50 },
                    { "menu_item_id": 103, "item_name": "Braised Pork Rice", "description": "Classic Taiwanese braised pork over rice.", "price_small": 80 }
                ]
            }
        };

        let testResults = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false
        };

        // 測試後端連線
        document.getElementById('test-backend').addEventListener('click', async () => {
            const apiBaseUrl = document.getElementById('api-base-url').value;
            const testMode = document.getElementById('test-mode').value;
            
            try {
                const response = await fetch(`${apiBaseUrl}/api/health`);
                if (response.ok) {
                    alert(`✅ 後端連線成功！\nAPI: ${apiBaseUrl}\n模式: ${testMode}`);
                } else {
                    alert(`❌ 後端連線失敗！\n狀態: ${response.status}`);
                }
            } catch (error) {
                alert(`❌ 後端連線失敗！\n錯誤: ${error.message}`);
            }
        });

        // 開始完整測試
        document.getElementById('start-test').addEventListener('click', async () => {
            // 重置測試狀態
            resetTestSteps();
            
            // 獲取測試參數
            const storeId = document.getElementById('store-id').value;
            const language = document.getElementById('language').value;
            const liffStatus = document.getElementById('liff-status').value;
            const apiBaseUrl = document.getElementById('api-base-url').value;
            const testMode = document.getElementById('test-mode').value;
            
            console.log('開始測試流程:', { storeId, language, liffStatus, apiBaseUrl, testMode });
            
            // 執行測試步驟
            await runTestStep1(storeId, language, liffStatus);
            await runTestStep2(storeId, language, apiBaseUrl, testMode);
            await runTestStep3();
            await runTestStep4();
            await runTestStep5(storeId, language, apiBaseUrl, testMode);
            
            // 顯示測試摘要
            showTestSummary();
        });

        function resetTestSteps() {
            testResults = {
                step1: false,
                step2: false,
                step3: false,
                step4: false,
                step5: false
            };
            
            // 重置所有步驟的視覺狀態
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step-${i}`);
                step.className = 'test-step bg-white p-4 rounded-lg shadow-md border-2 border-gray-200';
                document.getElementById(`step-${i}-content`).classList.add('hidden');
            }
            
            document.getElementById('test-summary').classList.add('hidden');
        }

        async function runTestStep1(storeId, language, liffStatus) {
            const step = document.getElementById('step-1');
            const content = document.getElementById('step-1-content');
            
            // 更新步驟狀態
            step.classList.add('active');
            
            // 模擬接收 LINE Bot 資料
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 顯示接收到的資料
            document.getElementById('received-store-id').textContent = storeId;
            document.getElementById('received-language').textContent = language;
            document.getElementById('received-liff-status').textContent = liffStatus === 'true' ? '已初始化' : '未初始化';
            
            content.classList.remove('hidden');
            step.classList.remove('active');
            step.classList.add('success');
            testResults.step1 = true;
            
            console.log('步驟 1 完成: 接收 LINE Bot 店家資訊');
        }

        async function runTestStep2(storeId, language, apiBaseUrl, testMode) {
            const step = document.getElementById('step-2');
            const content = document.getElementById('step-2-content');
            
            step.classList.add('active');
            
            const apiCall = `${apiBaseUrl}/api/menus/${storeId}?lang=${language}`;
            document.getElementById('menu-api-call').textContent = apiCall;
            
            try {
                let menuData;
                
                if (testMode === 'real') {
                    // 真實 API 呼叫
                    const response = await fetch(apiCall);
                    document.getElementById('menu-response-status').textContent = `${response.status} ${response.statusText}`;
                    
                    if (response.ok) {
                        menuData = await response.json();
                    } else {
                        throw new Error(`API 呼叫失敗: ${response.status}`);
                    }
                } else {
                    // 模擬資料
                    await new Promise(resolve => setTimeout(resolve, 500));
                    document.getElementById('menu-response-status').textContent = '200 OK (模擬)';
                    menuData = MOCK_MENU_DATA[language] || MOCK_MENU_DATA['zh-TW'];
                }
                
                // 顯示菜單資料
                const menuDataDiv = document.getElementById('menu-data');
                menuDataDiv.innerHTML = `
                    <p><strong>店家名稱:</strong> ${menuData.store_name}</p>
                    <p><strong>菜單項目:</strong> ${menuData.items.length} 項</p>
                    <div class="mt-2 text-xs">
                        ${menuData.items.map(item => 
                            `<div>• ${item.item_name} - NT$ ${item.price_small}</div>`
                        ).join('')}
                    </div>
                `;
                
                // 儲存菜單資料供後續步驟使用
                window.currentMenuData = menuData;
                
                content.classList.remove('hidden');
                step.classList.remove('active');
                step.classList.add('success');
                testResults.step2 = true;
                
                console.log('步驟 2 完成: 呼叫後端菜單 API');
                
            } catch (error) {
                document.getElementById('menu-response-status').textContent = `錯誤: ${error.message}`;
                step.classList.remove('active');
                step.classList.add('error');
                console.error('步驟 2 失敗:', error);
            }
        }

        async function runTestStep3() {
            const step = document.getElementById('step-3');
            const content = document.getElementById('step-3-content');
            
            step.classList.add('active');
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const menuData = window.currentMenuData;
            if (menuData && menuData.items) {
                document.getElementById('menu-items-count').textContent = menuData.items.length;
                
                const preview = document.getElementById('menu-preview');
                preview.innerHTML = `
                    <div class="text-xs space-y-1">
                        ${menuData.items.slice(0, 3).map(item => 
                            `<div class="flex justify-between">
                                <span>${item.item_name}</span>
                                <span class="text-blue-600">NT$ ${item.price_small}</span>
                            </div>`
                        ).join('')}
                        ${menuData.items.length > 3 ? `<div class="text-gray-500">... 還有 ${menuData.items.length - 3} 項</div>` : ''}
                    </div>
                `;
                
                content.classList.remove('hidden');
                step.classList.remove('active');
                step.classList.add('success');
                testResults.step3 = true;
                
                console.log('步驟 3 完成: 渲染菜單介面');
            } else {
                step.classList.remove('active');
                step.classList.add('error');
            }
        }

        async function runTestStep4() {
            const step = document.getElementById('step-4');
            const content = document.getElementById('step-4-content');
            
            step.classList.add('active');
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const menuData = window.currentMenuData;
            if (menuData && menuData.items) {
                // 模擬用戶選擇餐點
                const selectedItems = menuData.items.slice(0, 2).map(item => ({
                    ...item,
                    quantity: Math.floor(Math.random() * 3) + 1
                }));
                
                const simulation = document.getElementById('order-simulation');
                simulation.innerHTML = `
                    <div class="text-xs space-y-2">
                        ${selectedItems.map(item => 
                            `<div class="flex justify-between items-center">
                                <span>${item.item_name}</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-blue-600">NT$ ${item.price_small}</span>
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">x${item.quantity}</span>
                                </div>
                            </div>`
                        ).join('')}
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between font-semibold">
                                <span>總計:</span>
                                <span class="text-green-600">NT$ ${selectedItems.reduce((sum, item) => sum + (item.price_small * item.quantity), 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // 儲存模擬訂單資料
                window.simulatedOrder = selectedItems;
                
                content.classList.remove('hidden');
                step.classList.remove('active');
                step.classList.add('success');
                testResults.step4 = true;
                
                console.log('步驟 4 完成: 模擬點餐操作');
            } else {
                step.classList.remove('active');
                step.classList.add('error');
            }
        }

        async function runTestStep5(storeId, language, apiBaseUrl, testMode) {
            const step = document.getElementById('step-5');
            const content = document.getElementById('step-5-content');
            
            step.classList.add('active');
            
            const orderData = window.simulatedOrder;
            if (!orderData) {
                step.classList.remove('active');
                step.classList.add('error');
                return;
            }
            
            const orderItems = orderData.map(item => ({
                menu_item_id: item.menu_item_id,
                quantity: item.quantity,
                price: item.price_small
            }));
            
            const orderPayload = {
                store_id: parseInt(storeId),
                items: orderItems,
                language: language
            };
            
            const apiCall = `${apiBaseUrl}/api/orders`;
            document.getElementById('order-api-call').textContent = apiCall;
            
            try {
                let orderResult;
                
                if (testMode === 'real') {
                    // 真實 API 呼叫
                    const response = await fetch(apiCall, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderPayload)
                    });
                    
                    document.getElementById('order-response-status').textContent = `${response.status} ${response.statusText}`;
                    
                    if (response.ok) {
                        orderResult = await response.json();
                    } else {
                        throw new Error(`訂單 API 呼叫失敗: ${response.status}`);
                    }
                } else {
                    // 模擬資料
                    await new Promise(resolve => setTimeout(resolve, 500));
                    document.getElementById('order-response-status').textContent = '200 OK (模擬)';
                    orderResult = {
                        success: true,
                        message: '訂單建立成功',
                        order: {
                            order_id: `ORDER-${Date.now()}`,
                            store_id: parseInt(storeId),
                            items: orderItems,
                            total_amount: orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                            language: language,
                            created_at: new Date().toISOString()
                        }
                    };
                }
                
                // 顯示訂單結果
                const orderResultDiv = document.getElementById('order-result');
                orderResultDiv.innerHTML = `
                    <div class="text-xs space-y-1">
                        <p><strong>訂單編號:</strong> ${orderResult.order.order_id}</p>
                        <p><strong>總金額:</strong> NT$ ${orderResult.order.total_amount}</p>
                        <p><strong>建立時間:</strong> ${new Date(orderResult.order.created_at).toLocaleString()}</p>
                        <p><strong>狀態:</strong> <span class="text-green-600">成功</span></p>
                    </div>
                `;
                
                content.classList.remove('hidden');
                step.classList.remove('active');
                step.classList.add('success');
                testResults.step5 = true;
                
                console.log('步驟 5 完成: 送出訂單到後端');
                
            } catch (error) {
                document.getElementById('order-response-status').textContent = `錯誤: ${error.message}`;
                step.classList.remove('active');
                step.classList.add('error');
                console.error('步驟 5 失敗:', error);
            }
        }

        function showTestSummary() {
            const summary = document.getElementById('test-summary');
            const content = document.getElementById('summary-content');
            
            const passedSteps = Object.values(testResults).filter(result => result).length;
            const totalSteps = Object.keys(testResults).length;
            
            content.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">測試結果:</span>
                        <span class="${passedSteps === totalSteps ? 'text-green-600' : 'text-red-600'} font-bold">
                            ${passedSteps}/${totalSteps} 步驟通過
                        </span>
                    </div>
                    <div class="space-y-1 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="w-4 h-4 rounded-full ${testResults.step1 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span>步驟 1: 接收 LINE Bot 店家資訊</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-4 h-4 rounded-full ${testResults.step2 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span>步驟 2: 呼叫後端菜單 API</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-4 h-4 rounded-full ${testResults.step3 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span>步驟 3: 渲染菜單介面</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-4 h-4 rounded-full ${testResults.step4 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span>步驟 4: 模擬點餐操作</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="w-4 h-4 rounded-full ${testResults.step5 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span>步驟 5: 送出訂單到後端</span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-md">
                        <p class="text-sm">
                            <strong>結論:</strong> 
                            ${passedSteps === totalSteps 
                                ? '✅ 所有測試步驟都通過了！LINE Bot 到後端的整合流程運作正常。' 
                                : '❌ 部分測試步驟失敗，需要檢查相關的 API 連線和資料處理。'
                            }
                        </p>
                    </div>
                </div>
            `;
            
            summary.classList.remove('hidden');
        }
    </script>

</body>
</html> 