<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動語言偵測測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .log { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>自動語言偵測測試</h1>
    <p>這個測試模擬不同的語言偵測情境</p>
    
    <div id="test-results"></div>

    <script>
        // 模擬 LIFF 環境
        const mockLiff = {
            getLanguage: () => {
                // 模擬不同的語言設定
                const testCases = [
                    { name: "LINE中文", lang: "zh-TW" },
                    { name: "LINE英文", lang: "en" },
                    { name: "LINE日文", lang: "ja" },
                    { name: "LINE韓文", lang: "ko" }
                ];
                return testCases[Math.floor(Math.random() * testCases.length)].lang;
            }
        };

        // 模擬瀏覽器語言
        const mockNavigator = {
            language: "zh-TW"
        };

        // 語言偵測邏輯（複製自 index.html）
        function detectLanguage(preferredLang, urlLang, liffInitialized = true) {
            let detectedLanguage = preferredLang || urlLang;
            
            // 如果沒有URL參數，嘗試自動偵測LINE語言
            if (!detectedLanguage && liffInitialized) {
                try {
                    const liffLanguage = mockLiff.getLanguage();
                    console.log('LIFF自動偵測語言:', liffLanguage);
                    detectedLanguage = liffLanguage;
                } catch (error) {
                    console.log('LIFF語言偵測失敗，使用瀏覽器語言');
                    detectedLanguage = mockNavigator.language || 'zh-TW';
                }
            }
            
            // 如果還是沒有語言設定，使用預設值
            const language = detectedLanguage || 'zh-TW';
            
            // 語言代碼轉換
            const languageCodeMapping = {
                'en': 'en-US',
                'zh-TW': 'zh-TW', 
                'ja': 'ja-JP',
                'ko': 'ko-KR',
                'zh': 'zh-TW',
                'en-US': 'en-US',
                'ja-JP': 'ja-JP',
                'ko-KR': 'ko-KR'
            };
            const normalizedLanguage = languageCodeMapping[language] || 'zh-TW';
            
            return {
                detectedLanguage,
                language,
                normalizedLanguage
            };
        }

        // 測試案例
        const testCases = [
            {
                name: "URL參數優先 - 英文",
                preferredLang: "en",
                urlLang: null,
                expected: "en-US",
                description: "當URL有preferred_lang=en時，應該優先使用並轉換為en-US"
            },
            {
                name: "URL參數優先 - 中文",
                preferredLang: "zh-TW",
                urlLang: null,
                expected: "zh-TW",
                description: "當URL有preferred_lang=zh-TW時，應該保持zh-TW"
            },
            {
                name: "自動偵測 - LINE英文",
                preferredLang: null,
                urlLang: null,
                expected: "en-US",
                description: "當沒有URL參數時，應該自動偵測LINE語言並轉換"
            },
            {
                name: "自動偵測 - LINE日文",
                preferredLang: null,
                urlLang: null,
                expected: "ja-JP",
                description: "當沒有URL參數時，應該自動偵測LINE語言並轉換"
            },
            {
                name: "備用瀏覽器語言",
                preferredLang: null,
                urlLang: null,
                expected: "zh-TW",
                description: "當LIFF偵測失敗時，應該使用瀏覽器語言"
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            
            testCases.forEach((testCase, index) => {
                const div = document.createElement('div');
                div.className = 'test-case';
                
                // 執行測試
                const result = detectLanguage(testCase.preferredLang, testCase.urlLang);
                const isSuccess = result.normalizedLanguage === testCase.expected;
                
                div.className = `test-case ${isSuccess ? 'success' : 'error'}`;
                
                div.innerHTML = `
                    <h3>測試 ${index + 1}: ${testCase.name}</h3>
                    <p><strong>描述:</strong> ${testCase.description}</p>
                    <p><strong>輸入:</strong> preferredLang=${testCase.preferredLang}, urlLang=${testCase.urlLang}</p>
                    <p><strong>偵測結果:</strong></p>
                    <div class="log">
                        detectedLanguage: ${result.detectedLanguage}<br>
                        language: ${result.language}<br>
                        normalizedLanguage: ${result.normalizedLanguage}
                    </div>
                    <p><strong>預期結果:</strong> ${testCase.expected}</p>
                    <p><strong>測試結果:</strong> <span style="color: ${isSuccess ? 'green' : 'red'}">${isSuccess ? '✅ 通過' : '❌ 失敗'}</span></p>
                `;
                
                resultsDiv.appendChild(div);
            });
            
            // 添加總結
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-case info';
            summaryDiv.innerHTML = `
                <h3>測試總結</h3>
                <p>這個測試驗證了語言偵測的優先順序：</p>
                <ol>
                    <li><strong>URL參數優先</strong>: 如果URL中有preferred_lang參數，優先使用</li>
                    <li><strong>LIFF自動偵測</strong>: 如果沒有URL參數，嘗試偵測LINE語言</li>
                    <li><strong>瀏覽器語言備用</strong>: 如果LIFF偵測失敗，使用瀏覽器語言</li>
                    <li><strong>預設值</strong>: 最後使用zh-TW作為預設值</li>
                </ol>
                <p>語言代碼轉換確保了不同來源的語言代碼都能正確對應到LIFF網頁的完整代碼。</p>
            `;
            resultsDiv.appendChild(summaryDiv);
        }

        // 執行測試
        runTests();
    </script>
</body>
</html>
